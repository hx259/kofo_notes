\documentclass[a4paper,11pt]{article}
\usepackage{braket}
\usepackage{physics}
\usepackage{parskip}
\usepackage{bm}
\usepackage{float}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{pgfplots}
\usepackage{mathrsfs}
\usepackage{simpler-wick}
\usepackage{enumerate}
\usepackage{csquotes}
\usepackage{subcaption}
\usepackage{fancyhdr}
\usepackage{tablefootnote}
\usepackage{microtype}
\usepackage{cleveref}
\usepackage{titling}
\usepackage{erewhon}
\usepackage[a4paper,width=150mm,top=25mm,bottom=25mm]{geometry}
\usepackage[Sonny]{fncychap}
\usepackage[calcwidth]{titlesec}

\usetikzlibrary{shapes.geometric, arrows}

\allowdisplaybreaks

\pgfplotsset{compat=1.7}

%fncychap layout (for chapter page)
%\renewcommand{\thechapter}{\Roman{chapter}}
\ChNameVar{\bfseries\LARGE\fontfamily{phv}}
\ChNumVar{\fontsize{50}{52}\usefont{OT1}{ptm}{m}{n}\selectfont}
\ChTitleVar{\LARGE\rm\bfseries}
\ChRuleWidth{0.8pt}

%fancyhdr layout (for header and footer)
\pagestyle{fancy}
\fancyhead{}
\fancyhead[C]{\fontsize{9}{9}\itshape{\rightmark}}
\setlength{\headheight}{15pt}

\begin{document}

\section{NMR Shielding}
Shielding Tensor:
\begin{equation}
    \sigma _{\beta \alpha}^{K} = \frac{\dd{^{2}E}}{\dd{B _{\alpha}}\dd{m_{K_{\beta}}}}\Big|_{{\mathbf{B},\mathbf{m}_{K} =\mathbf{0}}}
\end{equation}
How do I parameterize energy $E$ with $\mathbf{B}$ and $\mathbf{m}_{K}$? \\
The one-electronic Hamiltonian in magnetic field:
\begin{equation}
    h(\mathbf{r},\mathbf{B},\mathbf{m}) = \frac{1}{2}\bm{\pi}^{2}-\phi(\mathbf{r})
\end{equation}
in which:
\begin{equation}
    \bm{\pi} = -i \bm{\nabla} + \mathbf{A}
\end{equation}
is the kinetic momentum operator.


Vector potential:
\begin{equation}
    \mathbf{A}_{i} = \mathbf{A}_{0}(\mathbf{r}_{i}) + \sum_{K}\mathbf{A}_{K}(\mathbf{r}_{i})
\end{equation} 
with:
\begin{align}
    \mathbf{A}_{0}(\mathbf{r}_{i}) &= \frac{1}{2}\mathbf{B}\times \mathbf{r}_{0} &\mathbf{B} &= \mathbf{\nabla}\times \mathbf{A}(\mathbf{r}) \\
    \mathbf{A}_{K}(\mathbf{r}_{i}) &= \alpha ^{2}\frac{\mathbf{M}_{K}\times \mathbf{r}_{K}}{r _{K}^{3}} &\mathbf{B}_{K}(\mathbf{r}) &= \mathbf{\nabla}\times \mathbf{A}_{K}(\mathbf{r})
\end{align}
The first part is contribution from the external magnetic field, the second part from the nuclear magnetic moments.
\\
Now parameterize with MO coefficients / densities?

\newpage
\section{SCF Level}
\begin{align}
    E ^{\text{SCF}} =& \sum_{i}^{N}h _{ii} + \frac{1}{2}\sum_{ij}^{N}\langle ij||ij\rangle \nonumber \\
    =& \sum_{i}\sum_{\mu \nu}C _{\mu i} ^{*} h _{\mu \nu}C _{\nu i} + \frac{1}{2}\sum_{ij}\langle ij||ij\rangle \\
    D ^{\text{SCF}}_{\mu \nu} =& \sum_{i}C ^{*}_{\mu i}C _{\nu i} \\
    C _{\mu p}(\lambda) =& \sum_{q}C _{\mu q}(0)U _{qp}(\lambda)
\end{align}
At SCF level, the NMR shielding tensor is given as:
\begin{align}
    \sigma ^{\text{SCF},K}_{\beta \alpha} =& \frac{\dd{^{2}E ^{\text{SCF}}}}{\dd{B _{\alpha}}\dd{m _{K _{\beta}}}}\Big|_{{\mathbf{B},\mathbf{m}_{K}=0}}
\end{align}
Taking the first derivative against the nuclear magnetic moment gives:
\begin{align}
    \dv{E ^{\text{SCF}}}{m _{K _{\beta}}} =& \dv{m _{K _{\beta}}}(\sum_{i \mu \nu}C _{\mu i}^{*}h _{\mu \nu}C _{\nu i}) \nonumber \\
    =& \sum_{i \mu \nu}C _{\mu i}^{*}C _{\nu i}\dv{h _{\mu \nu}}{m _{K _{\beta}}} \nonumber \\
    =& \sum_{\mu \nu}D ^{\text{SCF}} _{\mu \nu}\dv{h _{\mu \nu}}{m _{K _{\beta}}}
\end{align}
Note that the MO coefficients are variationally determined so $\dv{\mathbf{C}}{m _{K _{\beta}}}=\mathbf{0}$, and the basis function does not depend on the nuclear magnetic moment, i.e. $\dv{\phi _{\mu}}{m _{K _{\beta}}} = 0$ . \\
Now taking the second derivative w.r.t. the external magnetic field:
\begin{align}
    \sigma _{\beta \alpha}^{\text{SCF},K} =& \frac{\dd{^{2}E ^{\text{SCF}}}}{\dd{B _{\alpha}}\dd{m _{K _{\beta}}}} \nonumber \\
    =& \dv{B _{\alpha}}(\sum_{\mu \nu}D ^{\text{SCF}} _{\mu \nu}\dv{h _{\mu \nu}}{m _{K _{\beta}}}) \nonumber \\
    =& \sum_{\mu \nu}D ^{\text{SCF}} _{\mu \nu}\frac{\dd{^{2}h _{\mu \nu}}}{\dd{B _{\alpha}}\dd{m _{K _{\beta}}}} + \sum_{\mu \nu}\dv{D ^{\text{SCF}} _{\mu \nu}}{B _{\alpha}}\dv{h _{\mu \nu}}{m _{K _{\beta}}}
\end{align}
The response of SCF density to the magnetic field perturbation is:
\begin{align}
    \dv{D _{\mu \nu}^{\text{SCF}}}{B _{\alpha}} =& \dv{B _{\alpha}}(\sum_{i}C _{\mu i}^{*}(\mathbf{B})C _{\nu i}(\mathbf{B})) \nonumber \\
    =& \dv{B _{\alpha}}(\sum_{ipq}C ^{*}_{\mu p}(0)U ^{*}_{pi}(\mathbf{B})C _{\nu q}(0)U _{qi}(\mathbf{B})) \nonumber \\
    =& \sum_{ip}C ^{*}_{\mu p}(0)\dv{U ^{*} _{pi}(\mathbf{B})}{B _{\alpha}}C _{\nu i}(\mathbf{B}) + \sum_{iq}C _{\mu i}^{*}(\mathbf{B})\dv{U _{qi}(\mathbf{B})}{B _{\alpha}}C _{\nu q}(0) \\
    =& \sum_{ip}C ^{*}_{\mu p}(U _{pi}^{B _{\alpha}})^{*}C _{\nu i} + \sum_{ip}C _{\mu i}^{*}U _{pi}^{B _{\alpha}}C _{\nu p}
\end{align}
The virtual-occupied block of $\mathbf{U}^{\mathbf{B}}$ is obtained from the CPSCF equations, and the occupied-occupied block is chosen according to the orthonormality condition.










\newpage
\section{MP2 Level}
Lagrangian:
\begin{align}
    \mathcal{L}_{\text{MP2}} =& E _{\text{HF}} + E _{\text{H}} + \frac{1}{2}\sum_{ai}(z _{ai}f _{ai}+ z _{ai}^{*}f _{ai}^{*})
\end{align}
Energies:
\begin{align}
    E _{\text{HF}} =& \sum_{\mu \nu}h _{\mu \nu}D _{\mu \nu}^{\text{HF}} + \frac{1}{2}\sum_{ij}\langle ij||ij\rangle \\
    E _{\text{H}} =& \sum_{ij}h _{ij}\gamma ^{\text{H}} _{ij} + \sum_{ab}h _{ab}\gamma ^{\text{H}} _{ab} + \sum_{pqrs}\langle pq||rs\rangle \Gamma _{rs}^{pq} \nonumber \\
    =& \sum_{\mu \nu}D _{\mu \nu}^{\text{H}}h _{\mu \nu}^{\text{AO}} + \sum_{pqrs}\langle pq||rs\rangle \Gamma _{rs}^{pq}
\end{align} 
Unrelaxed densities:
\begin{align}
    D _{\mu \nu}^{\text{HF}} =& \sum_{i}C _{\mu i}^{*}C _{\mu i} \\
    D _{\mu \nu}^{\text{H}} =& \sum_{ij}C _{\mu i}^{*}C _{\nu j}\gamma _{ij}^{\text{H}} +\sum_{ab}C _{\mu a}^{*}C _{\nu b}\gamma _{ab}^{\text{H}} \\
\end{align}
Brillouin conditions:
\begin{align}
    \sum_{ai}z _{ai} f _{ai} =& \sum_{ai}z _{ai} h _{ai} + \sum_{aij}z _{ai}\langle aj||ij\rangle \nonumber \\
    =& \sum_{\mu \nu ai}z _{ai} C _{\mu a}^{*}C _{\nu i} h _{\mu \nu}^{\text{AO}} + \sum_{aij}z _{ai}\langle aj||ij\rangle \\
    \sum_{ai}z _{ai}^{*}f _{ai}^{*}=& \sum_{ai} z _{ai}^{*}h _{ai}^{*} + \sum_{aij}z _{ai}^{*}\langle aj||ij\rangle ^{*} \nonumber \\
    =& \sum_{ai}z _{ia}h _{ia} + \sum_{aij}z _{ia}\langle ij||aj\rangle \nonumber \\
    =& \sum_{\mu \nu ai}z _{ia}C _{\mu i}^{*}C _{\nu a}h _{\mu \nu}^{\text{AO}} + \sum_{aij}z _{ia}\langle ij||aj\rangle
\end{align}
\subsection{First Derivative}
We take the first derivative w.r.t. the nuclear magnetic moment $m _{K _{\beta}}$  as only one-electron Hamiltonian $h _{\mu \nu}$ depends on $m _{K _{\beta}}$:
\begin{align}
    \dv{\mathcal{L}_{\text{MP2}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} =& \pdv{\mathcal{L}_{\text{MP2}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \nonumber \\
    &+ \sum_{ijab}\left(\pdv{\mathcal{L}_{\text{MP2}}}{T _{ij}^{ab}}\right)\left(\pdv{T _{ij}^{ab}}{m _{K _{\beta}}}\right)\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \sum_{ijab}\left(\pdv{\mathcal{L}_{\text{MP2}}}{(T _{ij}^{ab})^{*}}\right)\left(\pdv{(T _{ij}^{ab})^{*}}{m _{K _{\beta}}}\right)\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \nonumber \\
    &+ \sum_{bj}\left(\pdv{\mathcal{L}_{\text{MP2}}}{\kappa _{bj}}\right)\left(\pdv{\kappa _{bj}}{m _{K _{\beta}}}\right)\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} 
    + \sum_{bj}\left(\pdv{\mathcal{L}_{\text{MP2}}}{\kappa _{bj}^{*}}\right)\left(\pdv{\kappa _{bj}^{*}}{m _{K _{\beta}}}\right)\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \nonumber \\
    &+ \sum_{bj}\left(\pdv{\mathcal{L}_{\text{MP2}}}{z _{bj}}\right)\left(\pdv{z _{bj}}{m _{K _{\beta}}}\right)\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \sum_{bj}\left(\pdv{\mathcal{L}_{\text{MP2}}}{z _{bj}^{*}}\right)\left(\pdv{z _{bj}^{*}}{m _{K _{\beta}}}\right)\Big|_{{\mathbf{m}_{K _{\beta}}=\mathbf{0}}} \nonumber \\
    =& \pdv{\mathcal{L}_{\text{MP2}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}}
\end{align}
\begin{align}
    \pdv{\mathcal{L}_{\text{MP2}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} =& \sum_{\mu \nu}D _{\mu \nu}^{\text{HF}}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \sum_{\mu \nu}D _{\mu \nu}^{\text{H}}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \nonumber \\
    &+ \frac{1}{2}\sum_{\mu \nu ai}z _{ai}C _{\mu a}^{*}C _{\nu i}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \frac{1}{2}\sum_{\mu \nu ai}z _{ia}C _{\mu i}^{*}C _{\nu a}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \nonumber \\
    =&\sum_{\mu \nu}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}}\left(D _{\mu \nu}^{\text{HF}}+ D _{\mu \nu}^{\text{H}} + \frac{1}{2}\sum_{ai}z _{ai}C _{\mu a}^{*}C _{\nu i} +\frac{1}{2}\sum_{ai}z _{ia}C _{\mu i}^{*}C _{\nu a}\right)
\end{align}
Using the Hermitian property of the one-body Hamiltonian:
\begin{align}
    &\sum_{\mu \nu ai}z _{ia}C _{\mu i}^{*}C _{\nu a}h _{\mu \nu}^{\text{AO}} \nonumber \\
    \stackrel{\mu \leftrightarrow \nu}{=}& \sum_{\mu \nu ai}\left(z _{ai}C _{\mu a}^{*}C _{\nu i}\right)^{*}h _{\nu \mu}^{\text{AO}} \nonumber \\
    =& \sum_{\mu \nu ai}(z _{ai}C _{\mu a}^{*}C _{\nu i})^{*}h _{\mu \nu}^{\text{AO}}
\end{align}
Therefore:
\begin{align}
    \pdv{\mathcal{L}_{\text{MP2}}}{m _{K _{\beta}}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} = \sum_{\mu \nu}D _{\mu \nu}^{\text{R}}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{\mathbf{m}_{K}=\mathbf{0}}
\end{align}
in which the orbital-relaxed density matrix is:
\begin{align}
    D _{\mu \nu}^{\text{R}} =& D _{\mu \nu}^{\text{HF}} + D _{\mu \nu}^{\text{H}} + \frac{1}{2}D _{\mu \nu}^{z} + \frac{1}{2}D _{\mu \nu}^{z *} \nonumber \\
    =& \sum_{i}C _{\mu i}^{*}C _{\nu i} + \sum_{ij}C _{\mu i}^{*}\gamma _{ij}^{\text{H}}C _{\nu j} + \sum_{ab}C _{\mu a}^{*}\gamma _{ab}^{\text{H}}C _{\nu b} \nonumber \\
    &+ \frac{1}{2}\sum_{ai} C _{\mu a}^{*} z _{ai}C _{\nu i} + \frac{1}{2}\sum_{ai}\big(C _{\mu a}^{*}z _{ai}C _{\nu i}\big)^{*}
\end{align}
In order to obtain the orbital-relaxed density matrices, we need:
\begin{itemize}
\item MO coefficients $C _{\mu p}$ from HF equation (Brillouin condition)
\item MP2 amplitudes $T _{ij}^{ab}$ from MP2 stationary condition
\item Z-Vector $z _{ai}$ from Z-Vector equation
\end{itemize}

\subsection{Stationary Constraints}

\subsubsection*{Brillouin Condition}
\begin{align}
    0=& \sum_{bj}\pdv{\mathcal{L}_{\text{MP2}}}{z _{bj}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \sum_{bj}\pdv{\mathcal{L}_{\text{MP2}}}{z _{bj}^{*}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \nonumber \\
    =& \frac{1}{2}\sum_{ai}\Big(\pdv{z _{ai}}{z _{bj}}f _{ai}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \pdv{z _{ai}^{*}}{z _{bj}^{*}}f _{ai}^{*}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \Big) \nonumber \\
    =& \frac{1}{2}\sum_{ai}\Big(\delta _{ab}\delta _{ij}f _{ai} + \delta _{ab}\delta _{ij}f _{ai}^{*}\Big) \nonumber \\
    =& \frac{1}{2}(f _{bj} + f _{bj}^{*})
\end{align}
\begin{align}
    f _{bj} = h _{bj} + \sum_{i}\langle bi||ji\rangle
\end{align}

\subsubsection*{MP2 Stationary Condition}
\begin{align}
    \pdv{\mathcal{L}_{\text{MP2}}}{T _{mn}^{ef}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} =& \pdv{E _{\text{H}}}{T _{mn}^{ef}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} = 0 \\
    \pdv{\mathcal{L}_{\text{MP2}}}{(T _{mn}^{ef})^{*}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} =& \pdv{E _{\text{H}}}{T _{mn}^{ef}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} =0
\end{align}
Solving these equations we can obtain the expressions for MP2 amplitudes as:
\begin{align}
    T _{ij}^{ab} =& \frac{\langle ab||ij\rangle}{\varepsilon _{i}+\varepsilon _{j}-\varepsilon _{a}-\varepsilon _{b}} \\
    (T _{ij}^{ab})^{*} =& \frac{\langle ij||ab\rangle}{\varepsilon _{i}+\varepsilon _{j}-\varepsilon _{a}-\varepsilon _{b}}
\end{align}




\subsubsection*{Orbital Rotation Condition}
\begin{align}
    0 =& \pdv{\mathcal{L}_{\text{MP2}}}{\kappa _{bj}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} = \pdv{E _{\text{H}}}{\kappa _{bj}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} + \frac{1}{2}\sum_{ai}z _{ai}\pdv{f _{ai}}{\kappa _{bj}}\Big|_{{\mathbf{m}_{K}=\mathbf{0}}} \\
    0 =& \pdv{\mathcal{L} _{\text{MP2}}}{\kappa _{bj}^{*}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} = \pdv{E _{\text{H}}}{\kappa _{bj}^{*}}\Big|_{\mathbf{m}_{K}=\mathbf{0}} + \frac{1}{2}\sum_{ai}z _{ai}^{*}\pdv{f _{ai}^{*}}{\kappa _{bj}}\Big|_{\mathbf{m}_{K}=\mathbf{0}}
\end{align}
These produces the Z-Vector equations:
\begin{align}
    \frac{1}{2}(\varepsilon _{b} - \varepsilon _{j})z _{bj}=& -X _{bj}             \\
    \frac{1}{2}(\varepsilon _{b}-\varepsilon _{j})z _{bj}^{*} =& -X _{bj}^{*} 
\end{align}
in which
\begin{equation}
    X _{bj} = \frac{1}{2}\sum_{iac}\langle ac||bi\rangle (T _{ji}^{ac})^{*}-\frac{1}{2}\sum_{ika}\langle ja||ik\rangle (T _{ik}^{ba})^{*} + \sum_{ac}\langle aj||cb\rangle \gamma _{ac}^{\text{H}} + \sum_{kl}\langle jk||bl\rangle \gamma _{kl}^{\text{H}}
\end{equation}


Now all parts of the orbital-relaxed density $D _{\mu \nu}^{\text{R}}$are ready, the first derivative could be computed.





\subsection{Second Derivative}
\begin{align}
    \frac{\dd{ ^{2}\mathcal{L}_{\text{MP2}}}}{\dd{ m _{K _{\beta}}}\dd{B _{\alpha}}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}} =& \frac{\partial ^{2}\mathcal{L} _{\text{MP2}}}{\partial m _{K _{\beta}}\partial B _{\alpha}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}} \nonumber \\
    =& \sum_{\mu \nu}D _{\mu \nu}^{\text{R}}\frac{\partial ^{2} h _{\mu \nu}^{\text{AO}}}{\partial m _{K _{\beta}}\partial B _{\alpha}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}} + \sum_{\mu \nu}\pdv{D _{\mu \nu}^{\text{R}}}{B _{\alpha}}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}}
\end{align} 
Need to get the response of orbital-relaxed density under external magnetic field, $\pdv{D _{\mu \nu}^{\text{R}}}{\mathbf{B}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}}$ for the second derivative. We should denote this as $D _{\mu \nu}^{\text{R},\mathbf{B}}$ for convenience.
\begin{align}
    D _{\mu \nu}^{\text{R}} =& D _{\mu \nu}^{\text{HF}} + D _{\mu \nu}^{\text{H}} + \frac{1}{2}D _{\mu \nu}^{z} + \frac{1}{2}D _{\mu \nu}^{z*} \nonumber \\
    =& \sum_{i}C _{\mu i}^{*}C _{\nu i} + \sum_{ij}C _{\mu i}^{*}\gamma _{ij}^{\text{H}}C _{\nu j} + \sum_{ab}C _{\mu a}^{*}\gamma _{ab}^{\text{H}}C _{\nu b} \nonumber \\
    &+ \frac{1}{2}\sum_{ai} C _{\mu a}^{*} z _{ai}C _{\nu i} + \frac{1}{2}\sum_{ai}\big(C _{\mu a}^{*}z _{ai}C _{\nu i}\big)^{*}
\end{align}
\begin{align}
    D _{\mu \nu}^{\text{R},\mathbf{B}} = D _{\mu \nu}^{\text{HF},\mathbf{B}} + D _{\mu \nu}^{\text{H}, \mathbf{B}} + \frac{1}{2}D _{\mu \nu}^{z,\mathbf{B}} +\frac{1}{2}D _{\mu \nu}^{z*,\mathbf{B}}
\end{align}
\begin{align}
    D _{\mu \nu}^{\text{HF}, \mathbf{B}} =& \sum_{i}C _{\mu i}^{*,\mathbf{B}}C _{\nu i} + \sum_{i}C _{\mu i}^{*}C _{\nu i}^{\mathbf{B}} \\
    D _{\mu \nu}^{\text{H}, \mathbf{B}} =& \sum_{ij}C _{\mu i}^{*, \mathbf{B}}\gamma _{ij}^{\text{H}}C _{\nu j} + \sum_{ij}C _{\mu i}^{*}\gamma _{ij}^{\text{H},\mathbf{B}}C _{\nu j} + \sum_{ij}C _{\mu i}^{*}\gamma _{ij}^{\text{H}}C _{\nu j}^{\mathbf{B}} \nonumber \\
    &+ \sum_{ab}C _{\mu a}^{*,\mathbf{B}}\gamma _{ab}^{\text{H}}C _{\nu b} + \sum_{ab}C _{\mu a}^{*}\gamma _{ab}^{\text{H},\mathbf{B}}C _{\nu b} + \sum_{ab}C _{\mu a}^{*}\gamma _{ab}^{\text{H}}C _{\nu b}^{\mathbf{B}}  \\
    D _{\mu \nu}^{z, \mathbf{B}}=& \sum_{ai}C _{\mu a}^{*,\mathbf{B}}z _{ai}C _{\nu i} + \sum_{ai}C _{\mu a}^{*}z _{ai}^{\mathbf{B}}C _{\nu i} + \sum_{ai}C _{\mu a}^{*}z _{ai}C _{\nu i}^{\mathbf{B}}
\end{align}
The responses $\kappa _{pq}^{\mathbf{B}}$ , $h _{\mu \nu}^{\text{AO},\mathbf{B}}$, $S _{\mu \nu}^{\text{AO},\mathbf{B}}$ and $\langle \mu \nu||\sigma \tau\rangle ^{\mathbf{B}}$ are needed for these density responses. For the second derivative,
$h _{\mu \nu}^{\text{AO},\mathbf{m}_{K}}$ and $h _{\mu \nu}^{\text{AO},\mathbf{m}_{K},\mathbf{B}}$ are also required.

\subsubsection*{HF Contribution}
$S ^{\text{AO},\mathbf{B}}_{\mu \nu}$ and $\kappa _{pq}^{\mathbf{B}}$ are needed for HF contribution to the relaxed density response.
\begin{align}
    C _{\mu p}(\mathbf{B}) =& \sum_{r}C _{\mu r}(0)U _{rp}(\mathbf{B}) \nonumber \\
    =& \sum_{rt}C _{\mu r}(0)(S ^{00})_{rt}^{-\frac{1}{2}}(\mathbf{B})\exp[-\bm{\kappa}(\mathbf{B})]_{tp} \\
    C _{\mu p}^{\mathbf{B}} =& \sum_{rt}C _{\mu r}(S ^{00}) _{rt}^{-\frac{1}{2},\mathbf{B}}\exp[-\bm{\kappa}]_{tp} + \sum_{rt}C _{\mu r}(S ^{00}) _{rt}^{-\frac{1}{2}}\exp[-\bm{\kappa}]_{tp}^{\mathbf{B}}
\end{align}
Since only first derivative of $\mathbf{C}$ is needed and $\bm{\kappa}(\mathbf{B}=\mathbf{0}) = \mathbf{I}$ , we can expand the exponential up to first order:
\begin{equation}
    \exp(-\bm{\kappa}) = \mathbf{I} - \bm{\kappa}
\end{equation}
\begin{align}
    C _{\mu p}^{\mathbf{B}} =& \sum_{rt}C _{\mu r}(S ^{00}) _{rt}^{-\frac{1}{2},\mathbf{B}}\delta _{tp} + \sum_{rt}C _{\mu r}(S ^{00}) _{rt}^{-\frac{1}{2}}(\delta _{tp}^{\mathbf{B}}-\kappa _{tp}^{\mathbf{B}}) \nonumber \\
    =& \sum_{r}C _{\mu r}(S ^{00}) _{rp}^{-\frac{1}{2},\mathbf{B}}-\sum_{rt}C _{\mu r}\delta _{rt}\kappa _{tp}^{\mathbf{B}} \nonumber \\
    =& \sum_{r}C _{\mu r}(S ^{00}) ^{-\frac{1}{2},\mathbf{B}}_{rp} - \sum_{r}C _{\mu r}\kappa _{rp}^{\mathbf{B}}
\end{align}
\begin{align}
    S ^{00,\mathbf{B}}_{pq} = \sum_{\mu \nu}C _{\mu p}^{*}(0)S _{\mu \nu}^{\text{AO},\mathbf{B}} C _{\nu q}(0)
\end{align}
and $(\mathbf{S} ^{00})^{-\frac{1}{2},\mathbf{B}}$ could be obtianed from differentiating the equation, noting that $\mathbf{S}^{00,\dagger} = \mathbf{S}^{00}$ and $\mathbf{S}^{00}(\mathbf{B}=\mathbf{0})=\mathbf{I}$ :
\begin{align}
    (\mathbf{S}^{00})^{-\frac{1}{2}\dagger}\mathbf{S}^{00}(\mathbf{S}^{00})^{-\frac{1}{2}} = \mathbf{I}
\end{align}
\begin{align}
    \mathbf{0}=&(\mathbf{S}^{00})^{-\frac{1}{2},\mathbf{B}}\mathbf{S}^{00}(\mathbf{S}^{00})^{-\frac{1}{2}}\Big|_{\mathbf{B}=\mathbf{0}} + (\mathbf{S}^{00})^{-\frac{1}{2}}\mathbf{S}^{00,\mathbf{B}}(\mathbf{S}^{00})^{-\frac{1}{2}}\Big|_{\mathbf{B}=\mathbf{0}} + (\mathbf{S}^{00})^{-\frac{1}{2}}\mathbf{S}^{00}(\mathbf{S}^{00})^{-\frac{1}{2},\mathbf{B}}\Big|_{\mathbf{B}=\mathbf{0}} \nonumber \\
    =&(\mathbf{S}^{00})^{-\frac{1}{2},\mathbf{B}} + \mathbf{S}^{00,\mathbf{B}} + (\mathbf{S}^{00})^{-\frac{1}{2},\mathbf{B}} \nonumber \\
    =&2(\mathbf{S}^{00}) ^{-\frac{1}{2},\mathbf{B}} + \mathbf{S}^{00,\mathbf{B}}
\end{align}
Therefore:
\begin{equation}
    (\mathbf{S}^{00})^{-\frac{1}{2},\mathbf{B}} = -\frac{1}{2}\mathbf{S}^{00,\mathbf{B}}
\end{equation}

\subsubsection*{Hylleraas Contribution}
For Hylleraas contribution, we need $S ^{\text{AO},\mathbf{B}}_{\mu \nu}$, $\kappa _{pq}^{\mathbf{B}}$ and $\langle \mu \nu||\sigma \tau\rangle ^{\mathbf{B}}$, as the MP2 amplitudes depend on the two-electron integrals.
\begin{align}
    \gamma _{ij}^{\text{H}} =& \frac{1}{2}\sum_{kab}(T ^{ab}_{jk})^{*}T _{ki}^{ab} \\
    \gamma _{ab}^{\text{H}} =& -\frac{1}{2}\sum_{ijc}(T _{ij}^{ac})^{*}T _{ij}^{cb}
\end{align}
\begin{align}
    \gamma _{ij}^{\text{H},\mathbf{B}} =& \frac{1}{2}\sum_{kab}(T _{jk}^{ab})^{*,\mathbf{B}}T _{ki}^{ab} + \frac{1}{2}\sum_{kab}(T _{jk}^{ab})^{*}(T _{ki}^{ab})^{\mathbf{B}} \\
    \gamma _{ab}^{\text{H},\mathbf{B}} =& -\frac{1}{2}\sum_{ijc}(T _{ij}^{ac})^{*,\mathbf{B}}T _{ij}^{cb} -\frac{1}{2}\sum_{ijc}(T _{ij}^{ac})^{*}(T _{ij}^{cb})^{\mathbf{B}}
\end{align}
The MP2 amplitude response:
\begin{align}
    T _{ij}^{ab} =& \frac{\langle ab||ij\rangle}{\varepsilon _{i}+\varepsilon _{j}-\varepsilon _{a}-\varepsilon _{b}} = \frac{1}{\Delta _{ab}^{ij}}\langle ab||ij\rangle \\
    (T _{ij}^{ab})^{*} =& \frac{\langle ij||ab\rangle}{\varepsilon _{i}+\varepsilon _{j}-\varepsilon _{a}-\varepsilon _{b}} = \frac{1}{\Delta _{ab}^{ij}}\langle ij||ab\rangle
\end{align}
\begin{align}
    \langle pq||rs\rangle^{\mathbf{B}} =& \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle ^{\mathbf{B}} C _{\sigma r}C _{\tau s} \nonumber \\
    &+ \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*,\mathbf{B}}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}C _{\tau s} + \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu q}^{*,\mathbf{B}}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}C _{\tau s} \nonumber \\
    &+  \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}^{\mathbf{B}}C _{\tau s} + \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu q}^{*}\langle \mu \nu ||\sigma \tau\rangle C _{\sigma r}C _{\tau s}^{\mathbf{B}}
\end{align}
\begin{align}
    (\Delta _{ab}^{ij})^{\mathbf{B}} =& \varepsilon _{i}^{\mathbf{B}} + \varepsilon _{j}^{\mathbf{B}} - \varepsilon _{a}^{\mathbf{B}} - \varepsilon _{b}^{\mathbf{B}}
\end{align}
\begin{align}
    f _{pq}^{\mathbf{B}} =& h _{pq}^{\mathbf{B}} + \sum_{i}\langle pi||qi\rangle ^{\mathbf{B}}
\end{align}
\begin{align}
    h _{pq}^{\mathbf{B}} =& \sum_{\mu \nu}C _{\mu p}^{*,\mathbf{B}}h _{\mu \nu}^{\text{AO}}C _{\nu q} + \sum_{\mu \nu}C _{\mu p}^{*}h _{\mu \nu}^{\text{AO},\mathbf{B}}C _{\nu q} + \sum_{\mu \nu}C _{\mu p}^{*}h _{\mu \nu}^{\text{AO}}C _{\nu q}^{\mathbf{B}}
\end{align}
\begin{align}
    (T _{ij}^{ab})^{\mathbf{B}} =& \frac{\langle ab||ij\rangle ^{\mathbf{B}}\Delta _{ab}^{ij} - \langle ab||ij\rangle (\Delta _{ab}^{ij})^{\mathbf{B}}}{(\Delta _{ab}^{ij})^{2}} \nonumber \\
    =& \frac{\langle ab||ij\rangle ^{\mathbf{B}}}{\Delta _{ab}^{ij}} - \frac{1}{\Delta _{ab}^{ij}}\Big(\sum_{m}\frac{\langle ab||im\rangle}{\Delta _{ab}^{im}}f _{mj}^{\mathbf{B}} + \sum_{m}\frac{\langle ab||mj\rangle}{\Delta _{ab}^{mj}}f _{mi}^{\mathbf{B}} \nonumber \\
    &-\sum_{e}\frac{\langle ae||ij\rangle}{\Delta _{ae}^{ij}}f _{eb}^{\mathbf{B}} - \sum_{e}\frac{\langle eb||ij\rangle}{\Delta _{eb}^{ij}}f _{ae}^{\mathbf{B}} \Big) \nonumber \\
    =& \frac{1}{\Delta _{ab}^{ij}}\left(\langle ab||ij\rangle ^{\mathbf{B}} - \sum_{m}T ^{ab}_{im}f _{mj}^{\mathbf{B}} - \sum_{m}T _{mj}^{ab}f _{mi}^{\mathbf{B}}+ \sum_{e}T ^{ae}_{ij}f _{eb}^{\mathbf{B}}+\sum_{e}T ^{eb}_{ij}f _{ae}^{\mathbf{B}}\right) \\
    (T _{ij}^{ab})^{*,\mathbf{B}} =& \frac{1}{\Delta _{ab}^{ij}}\left(\langle ij||ab\rangle ^{\mathbf{B}} - \sum_{m}(T ^{ab}_{im})^{*}f _{mj}^{\mathbf{B}}-\sum_{m}(T _{mj}^{ab})^{*}f _{mi}^{\mathbf{B}}+\sum_{e}(T _{ij}^{ae})^{*}f _{eb}^{\mathbf{B}}+\sum_{e}(T _{ij}^{eb})^{*}f _{ae}^{\mathbf{B}}\right)
\end{align}


\subsubsection*{Z-Vector Contribution}
The perturbed Z-vectors are obtained by differentiating the zero-th order Z-vector equation and solving it iteratively:
\begin{align}
    \frac{1}{2} z _{bj}(\varepsilon _{b}-\varepsilon _{j}) + \frac{1}{2}\sum_{ai}\left(z _{ai}\langle aj||ib\rangle + z ^{*}_{ai}\langle ij||ab\rangle\right) = -X _{bj} \\
    X _{bj} = \frac{1}{2}\sum_{iac}\langle ac||bi\rangle (T _{ji}^{ac})^{*}-\frac{1}{2}\sum_{ika}\langle ja||ik\rangle (T _{ik}^{ba})^{*} + \sum_{ac}\langle aj||cb\rangle \gamma _{ac}^{\text{H}} + \sum_{kl}\langle jk||bl\rangle \gamma _{kl}^{\text{H}}
\end{align}
Differentiating the LHS:
\begin{align}
    &\pdv{\mathbf{B}}\left(\frac{1}{2} z _{bj}(\varepsilon _{b}-\varepsilon _{j}) + \frac{1}{2}\sum_{ai}\left(z _{ai}\langle aj||ib\rangle + z ^{*}_{ai}\langle ij||ab\rangle\right)\right) \nonumber \\
    =& \frac{1}{2}z _{bj}^{\mathbf{B}}(\varepsilon _{b}-\varepsilon _{j}) +\frac{1}{2}\sum_{ai}\left(z _{ai}^{\mathbf{B}}\langle aj||ib\rangle + z _{ai}^{*,\mathbf{B}}\langle ij||ab\rangle\right) \nonumber \\
    &+ \frac{1}{2}z _{bj}(\varepsilon _{b}^{\mathbf{B}}-\varepsilon _{j}^{\mathbf{B}}) + \frac{1}{2}\sum_{ai}\left(z _{ai}\langle aj||ib\rangle ^{\mathbf{B}} + z _{ai}^{*}\langle ij||ab\rangle ^{\mathbf{B}}\right)
\end{align}
and the RHS:
\begin{align}
    \pdv{X _{bj}}{\mathbf{B}} =& \frac{1}{2}\sum_{iac}\langle ac||bi\rangle ^{\mathbf{B}}(T _{ji}^{ac})^{*} + \frac{1}{2}\sum_{iac}\langle ac||bi\rangle (T _{ji}^{ac})^{*,\mathbf{B}}
    -\frac{1}{2}\sum_{ika}\langle ja||ik\rangle ^{\mathbf{B}}(T _{ik}^{ba})^{*} -\frac{1}{2}\sum_{ika}\langle ja||ik\rangle (T _{ik}^{ba})^{*,\mathbf{B}} \nonumber \\ 
    &+ \sum_{ac}\langle aj||cb\rangle ^{\mathbf{B}}\gamma _{ac}^{\text{H}}+\sum_{ac}\langle aj||cb\rangle \gamma _{ac}^{\text{H},\mathbf{B}}
    + \sum_{kl}\langle jk||bl\rangle ^{\mathbf{B}}\gamma _{kl}^{\text{H}} + \sum_{kl}\langle jk||bl\rangle \gamma _{kl}^{\text{H},\mathbf{B}}
\end{align}


\newpage
\subsection{Implementation Plan}
\begin{align}
    \frac{\dd{ ^{2}\mathcal{L}_{\text{MP2}}}}{\dd{ m _{K _{\beta}}}\dd{B _{\alpha}}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}} = \sum_{\mu \nu}D _{\mu \nu}^{\text{R}}\frac{\partial ^{2} h _{\mu \nu}^{\text{AO}}}{\partial m _{K _{\beta}}\partial B _{\alpha}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}} + \sum_{\mu \nu}\pdv{D _{\mu \nu}^{\text{R}}}{B _{\alpha}}\pdv{h _{\mu \nu}^{\text{AO}}}{m _{K _{\beta}}}\Big|_{\mathbf{B},\mathbf{m}_{K}=\mathbf{0}}
\end{align} 

\subsubsection*{Orbital-Relaxed Density}
Parts needed to compute relaxed density $D _{\mu \nu}^{\text{R}}$: 

\begin{itemize}
\item MO coefficients for occupied orbitals $C _{\mu i}$  
\item MO coefficients for virtual orbitals $C _{\mu a}$
\item 2 e integrals $\langle pq||rs\rangle$ 
\item 1 e integrals $h _{pq}$ 
\end{itemize}

Main steps:
\begin{enumerate}
\item Compute MP2 amplitudes using $\langle pq||rs\rangle$ and $h _{pq}$ (or are orbital energies directly available?)
\item Compute the X-intermediates using $\langle pq||rs\rangle$ and MP2 amplitudes
\item Compute Z-vectors with X-intermediates and orbital energies
\item Make contractions to compute $D _{\mu \nu}^{\text{AO}}$ 
\end{enumerate}

\subsubsection*{Density Response to Magnetic Field}
Additional parts needed to compute $D _{\mu \nu}^{\text{R},\mathbf{B}}$:

\begin{itemize}
\item perturbed orbital rotation matrix $\kappa _{pq}^{\mathbf{B}}$ 
\item perturbed AO 1e integral $h _{\mu \nu}^{\text{AO},\mathbf{B}}$ 
\item perturbed AO overlap integral $S _{\mu \nu}^{\text{AO},\mathbf{B}}$ 
\item perturbed AO 2e integral $\langle \mu \nu||\sigma \tau\rangle ^{\mathbf{B}}$ 
\end{itemize}

Main steps:
\begin{enumerate}
\item Compute $S _{pq} ^{00,\mathbf{B}}$ with unperturbed MO coefficients $C _{\mu p}$ and $S _{\mu \nu}^{\text{AO},\mathbf{B}}$  
\item Compute the perturbed MO coefficients $C _{\mu p}^{\mathbf{B}}$ with $\kappa _{pq}^{\mathbf{B}}$ and $S _{pq} ^{00,\mathbf{B}}$ 
\item Compute the perturbed MO 2e integrals $\langle pq||rs\rangle ^{\mathbf{B}}$ with $\langle pq||rs\rangle$ and $C _{\mu p}^{\mathbf{B}}$  
\item Compute the perturbed fock matrix $f _{pq}^{\mathbf{B}}$ using $h _{\mu \nu}^{\text{AO},\mathbf{B}}$ and $\langle pq||rs \rangle ^{\mathbf{B}}$ 
\item Compute the perturbed MP2 amplitudes $(T _{ij}^{ab})^{\mathbf{B}}$ with $f _{pq}^{\mathbf{B}}$, $\langle pq||rs\rangle ^{\mathbf{B}}$  and $T _{ij}^{ab}$
\item Compute the perturbed Hylleraas 1-RDMs $\gamma _{ij}^{\text{H},\mathbf{B}}$ and $\gamma _{ab}^{\text{H},\mathbf{B}}$ with $(T _{ij}^{ab})^{\mathbf{B}}$ and $T _{ij}^{ab}$  
\item Compute the perturbed X-intermediates $X _{bj}^{\mathbf{B}}$  using $(T _{ij}^{ab})^{\mathbf{B}}$, $T _{ij}^{ab}$, $\langle pq||rs\rangle ^{\mathbf{B}}$ and perturbed 1-RDMs
\item Compute the perturbed Z-vectors $z _{bj}^{\mathbf{B}}$  with $X _{bj}^{\mathbf{B}}$, $f _{pq}^{\mathbf{B}}$ and $z _{bj}$ 
\item Make contractions to compute $D _{\mu \nu}^{\text{R},\mathbf{B}}$ 
\end{enumerate}

\subsubsection*{Second derivative}
Additional parts needed to compute the second derivative:
\begin{itemize}
\item $h _{\mu \nu}^{\text{AO},\mathbf{m}_{K}}$ 
\item $h _{\mu \nu}^{\text{AO},\mathbf{B},\mathbf{m}_{K}}$ 
\end{itemize}












\end{document}