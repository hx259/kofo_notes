\documentclass[a4paper,11pt]{article}
\usepackage{braket}
\usepackage{physics}
\usepackage{parskip}
\usepackage{bm}
\usepackage{float}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{pgfplots}
\usepackage{mathrsfs}
\usepackage{simpler-wick}
\usepackage{enumerate}
\usepackage{csquotes}
\usepackage{subcaption}
\usepackage{fancyhdr}
\usepackage{tablefootnote}
\usepackage{microtype}
\usepackage{cleveref}
\usepackage{titling}
\usepackage{erewhon}
\usepackage[a4paper,width=150mm,top=25mm,bottom=25mm]{geometry}
\usepackage[Sonny]{fncychap}
\usepackage[calcwidth]{titlesec}

\usetikzlibrary{shapes.geometric, arrows}

\allowdisplaybreaks

\pgfplotsset{compat=1.7}

%fncychap layout (for chapter page)
%\renewcommand{\thechapter}{\Roman{chapter}}
\ChNameVar{\bfseries\LARGE\fontfamily{phv}}
\ChNumVar{\fontsize{50}{52}\usefont{OT1}{ptm}{m}{n}\selectfont}
\ChTitleVar{\LARGE\rm\bfseries}
\ChRuleWidth{0.8pt}

%fancyhdr layout (for header and footer)
\pagestyle{fancy}
\fancyhead{}
\fancyhead[C]{\fontsize{9}{9}\itshape{\rightmark}}
\setlength{\headheight}{15pt}

\begin{document}
\section{Direct Differentiation}
MP2 energy in spin-orbital formalism:
\begin{align}
    E ^{(2)} =& \frac{1}{4}\sum_{ijab}\frac{\langle ab||ij\rangle \langle ij||ab\rangle}{f _{ii}+f _{jj}-f _{aa}-f _{bb}} \nonumber \\
    =& \frac{1}{4}\sum_{ijab}T _{ij}^{ab}\langle ij||ab\rangle
\end{align}
in which we denote the MP2 amplitude:
\begin{equation}
    T _{ij}^{ab} = \frac{\langle ab||ij\rangle}{\Delta _{ab}^{ij}} = \frac{\langle ab||ij\rangle}{f _{ii}+f _{jj}-f _{aa}-f _{bb}}
\end{equation} 
Directly differentiate the second-order energy w.r.t. perturbation parameter $\lambda$:
\begin{align}
    \pdv{E ^{(2)}}{\lambda} =& \frac{1}{4}\sum_{ijab}\pdv{\lambda}(T _{ij}^{ab}\langle ij||ab\rangle) \nonumber \\
    =&\frac{1}{4}\sum_{ijab}\Big(\pdv{T _{ij}^{ab}}{\lambda}\Big)\langle ij||ab\rangle + \frac{1}{4}\sum_{ijab}T _{ij}^{ab} \Big(\pdv{\langle ij||ab\rangle}{\lambda}\Big)
\end{align}
in which:
\begin{align}
    \pdv{\langle ij||ab\rangle}{\lambda} = \langle i ^{\lambda}j||ab\rangle + \langle ij ^{\lambda}||ab\rangle + \langle ij||a ^{\lambda}b\rangle + \langle ij||ab ^{\lambda}\rangle
\end{align} 
exploiting the permutational symmetry and equivalence of the dummy indices:
\begin{align}
    \sum_{ijab}\langle ij ^{\lambda}||ab\rangle = \sum_{ijab}\langle j ^{\lambda}i||ba\rangle = \sum_{jiba}\langle i ^{\lambda}j||ab\rangle
\end{align}
Therefore:
\begin{equation}
    \sum_{ijab}\langle ij||ab\rangle ^{\lambda} = 2 \sum_{ijab}(\langle i ^{\lambda}j||ab\rangle + \langle ij||a ^{\lambda}b\rangle)
\end{equation}
Then:
\begin{align}
    \pdv{T _{ij}^{ab}}{\lambda} =& \pdv{\lambda}(\frac{\langle ab||ij\rangle}{\Delta _{ab}^{ij}}) \nonumber \\
    =& \frac{\langle ab||ij\rangle ^{\lambda}}{\Delta _{ab}^{ij}} - \frac{\langle ab||ij\rangle}{(\Delta _{ab}^{ij})^{2}}\Big(\pdv{\Delta _{ab}^{ij}}{\lambda}\Big) \nonumber \\
    =&  \frac{\langle ab||ij\rangle ^{\lambda}}{\Delta _{ab}^{ij}} - \frac{\langle ab||ij\rangle}{(\Delta _{ab}^{ij})^{2}}(\varepsilon _{i} ^{\lambda} + \varepsilon _{j}^{\lambda} - \varepsilon _{a}^{\lambda}-\varepsilon _{b}^{\lambda})
\end{align}
Putting eqns (6) and (7) together:
\begin{align}
    \pdv{E ^{(2)}}{\lambda} =& \frac{1}{4}\sum_{ijab}\langle ij||ab\rangle (T _{ij}^{ab})^{\lambda} + \frac{1}{4}\sum_{ijab}T _{ij}^{ab}\langle ij||ab\rangle ^{\lambda} \nonumber \\
    =& \frac{1}{4}\sum_{ijab}\langle ij||ab\rangle\Big(\frac{\langle ab||ij\rangle ^{\lambda}}{\Delta _{ab}^{ij}}-\frac{\langle ab||ij\rangle}{(\Delta _{ab}^{ij})^{2}}(\varepsilon _{i} ^{\lambda} + \varepsilon _{j}^{\lambda} - \varepsilon _{a}^{\lambda}-\varepsilon _{b}^{\lambda})\Big) + \frac{1}{4}\sum_{ijab}\langle ij||ab\rangle ^{\lambda}T _{ij} ^{ab} \nonumber \\
    =& \frac{1}{4}\sum_{ijab}\frac{\langle ij||ab\rangle\langle ab||ij\rangle ^{\lambda}}{\Delta _{ab}^{ij}} + \frac{1}{4}\sum_{ijab}\frac{\langle ij||ab\rangle ^{\lambda}\langle ab||ij\rangle}{\Delta _{ab}^{ij}}- \frac{1}{4}\sum_{ijab}\frac{\langle ij||ab\rangle\langle ab||ij\rangle}{(\Delta _{ab}^{ij})^{2}}(2 \varepsilon _{i}^{\lambda} -2 \varepsilon _{a}^{\lambda})  \nonumber \\
    =& \frac{1}{2}\sum_{ijab}(T _{ij}^{ab})^{*}\langle a ^{\lambda}b||ij\rangle + \frac{1}{2}\sum_{ijab}(T _{ij}^{ab})^{*}\langle ab||i ^{\lambda}j\rangle + \frac{1}{2}\sum_{ijab}T ^{ab}_{ij}\langle i ^{\lambda}j||ab\rangle + \frac{1}{2}\sum_{ijab} T _{ij}^{ab}\langle ij||a ^{\lambda}b\rangle \nonumber \\
    &- \frac{1}{2}\sum_{ijab}T _{ij}^{ab}(T _{ij}^{ab})^{*}(\varepsilon _{i}^{\lambda}-\varepsilon _{a}^{\lambda})
\end{align}
Using the expression for $|i ^{\lambda}\rangle$ and $|a ^{\lambda}\rangle$:
\begin{align}
    \pdv{E ^{(2)}}{\lambda}=& \frac{1}{2}\sum_{ijab}(T _{ij}^{ab})^{*}\Big(\sum_{k}(U _{ka}^{\lambda})^{*}\langle kb||ij\rangle + \sum_{f\neq a}(U _{fa}^{\lambda})^{*}\langle fb||ij\rangle + \sum_{\mu}C _{\mu a}^{*}\langle \mu ^{\lambda} b||ij\rangle\Big) \nonumber \\
    &+ \frac{1}{2}\sum_{ijab}(T _{ij}^{ab})^{*}\Big(\sum_{k\neq i}U _{ki}^{\lambda}\langle ab||kj\rangle + \sum_{f}U _{fi}^{\lambda}\langle ab||fj\rangle + \sum_{\mu}C _{\mu i}\langle ab||\mu ^{\lambda} j\rangle\Big) \nonumber \\
    &+ \frac{1}{2}\sum_{ijab}T _{ij}^{ab}\Big(\sum_{k\neq i}(U _{ki}^{\lambda})^{*}\langle kj||ab\rangle + \sum_{f}(U _{fi}^{\lambda})^{*}\langle fj||ab\rangle + \sum_{\mu}C _{\mu i}^{*}\langle \mu ^{\lambda} j||ab\rangle\Big) \nonumber \\
    &+ \frac{1}{2}\sum_{ijab}T _{ij}^{ab}\Big(\sum_{k}U _{ka}^{\lambda}\langle ij||kb\rangle + \sum_{f\neq a}U _{fa}^{\lambda}\langle ij||fb\rangle + \sum_{\mu}C _{\mu a}\langle ij||\mu ^{\lambda}b\rangle\Big) \nonumber \\
    &-\frac{1}{2}\sum_{ijab}T _{ij}^{ab}(T _{ij}^{ab})^{*}(\varepsilon _{i}^{\lambda}-\varepsilon _{a}^{\lambda})
\end{align}
Using the orthonormality condition on $(U _{ka}^{\lambda})^{*}$, $(U _{fa}^{\lambda})^{*}$, $(U _{ki}^{\lambda})^{*}$ and $U _{ka}^{\lambda}$, and omitting the AO terms (terms involving $|\phi _{\mu}\rangle$) for now:
\begin{align}
    \pdv{E ^{(2)}}{\lambda} =& \frac{1}{2}\sum_{ijab}\sum_{k}(T ^{ab}_{ij})^{*}\langle kb||ij\rangle(-S _{ak}^{\lambda} - U _{ak}^{\lambda}) + \frac{1}{2}\sum_{ijab}\sum_{f\neq a}(T _{ij}^{ab})^{*}\langle fb||ij\rangle(-S _{af}^{\lambda}-U _{af}^{\lambda}) \nonumber \\
    &+ \frac{1}{2}\sum_{ijab}\sum_{k\neq i}(T _{ij}^{ab})^{*}\langle ab||kj\rangle U _{ki}^{\lambda} + \frac{1}{2}\sum_{ijab}\sum_{f}(T _{ij}^{ab})^{*}\langle ab||fi\rangle U _{fi}^{\lambda} \nonumber \\
    &+ \frac{1}{2}\sum_{ijab}\sum_{k\neq i}T _{ij}^{ab}\langle kj||ab\rangle (-S _{ik}^{\lambda}-U _{ik}^{\lambda}) + \frac{1}{2}\sum_{ijab}\sum_{f}T _{ij}^{ab}\langle fj||ab\rangle (U _{fi}^{\lambda})^{*} \nonumber \\
    &+ \frac{1}{2}\sum_{ijab}\sum_{k}T _{ij}^{ab}\langle ij||kb\rangle(-S _{ak}^{\lambda}-(U _{ak}^{\lambda})^{*}) + \frac{1}{2}\sum_{ijab}\sum_{f\neq a}T _{ij}^{ab}\langle ij||fb\rangle U _{fa}^{\lambda} \nonumber \\
    &-\frac{1}{2}\sum_{ijab}T _{ij}^{ab}(T _{ij}^{ab})^{*}(\varepsilon _{i}^{\lambda}-\varepsilon _{a}^{\lambda}) + \text{AO terms}
\end{align}
collecting the $U _{af}^{\lambda}$ and $U _{fa}^{\lambda}$ terms and swapping some dummy indices:\\
\begin{align}
    A =&-\frac{1}{2}\sum_{ijab}\sum_{f\neq a} (T _{ij}^{ab})^{*}\langle fb||ij\rangle U _{af}^{\lambda} + \frac{1}{2} \sum_{ijab}\sum_{f\neq a}T _{ij}^{ab}\langle ij||fb\rangle U _{fa}^{\lambda} \nonumber \\
    =&- \frac{1}{2}\sum_{ijfb}\sum_{a\neq f}(T _{ij}^{fb})^{*}\langle ab||ij\rangle U _{fa}^{\lambda} + \frac{1}{2} \sum_{ijab}\sum_{f\neq a}T _{ij}^{ab}\langle ij||fb\rangle U _{fa}^{\lambda} \nonumber \\
    =& \frac{1}{2}\sum_{ijab}\sum_{f\neq a}\langle ij||fb\rangle \langle ab||ij\rangle U _{fa}^{\lambda}\Big(\frac{1}{\Delta _{ab}^{ij}}-\frac{1}{\Delta _{fb}^{ij}}\Big) \nonumber \\
    =& \frac{1}{2}\sum_{ijab}\sum_{f\neq a}\langle ij||fb\rangle \langle ab||ij\rangle U _{fa}^{\lambda}\frac{\epsilon _{a}-\epsilon _{f}}{\Delta _{ab}^{ij}\Delta _{fb}^{ij}}
\end{align}
using the expression for $U _{fa}^{\lambda}$:
\begin{align}
    A =& \frac{1}{2}\sum_{ijab}\sum_{f\neq a}\frac{\langle ij||fb\rangle\langle ab||ij\rangle(Q _{fa}^{\lambda}+\sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle fg||am\rangle])}{\Delta _{ab}^{ij}\Delta _{fb}^{ij}} \nonumber \\
    =& \frac{1}{2}\sum_{ijab}\sum_{f\neq a}T _{ij}^{ab}(T _{ij}^{fb})^{*}\Big(Q _{fa}^{\lambda}+\sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle fg||am\rangle]\Big)
\end{align}
evaluating the $\varepsilon _{a}^{\lambda}$ term in $\pdv{E ^{(2)}}{\lambda}$ expression:
\begin{align}
    \frac{1}{2}\sum_{ijab}T _{ij}^{ab}(T _{ij}^{ab})^{*}\varepsilon _{a}^{\lambda} =&\frac{1}{2}\sum_{ijab}T _{ij}^{ab}(T _{ij}^{ab})^{*}\Big(Q _{aa}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle am||ag\rangle + (U _{gm}^{\lambda})^{*}\langle ag||am\rangle]\Big) \nonumber \\
    =& \frac{1}{2}\sum_{ijab}\sum_{f=a}T _{ij}^{ab}(T _{ij}^{fb})^{*}(Q _{fa}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle fg||am\rangle])
\end{align}
add this term into $A$:
\begin{equation}
    A + \frac{1}{2}\sum_{ijab}T _{ij}^{ab}(T _{ij}^{ab})^{*}\varepsilon _{a}^{\lambda} = \frac{1}{2}\sum_{ijabf}T _{ij}^{ab}(T _{ij}^{fb})^{*}\Big(Q _{fa}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle fg||am\rangle]\Big)
\end{equation}
Similarly, collecting the $U _{ki}^{\lambda}$ and $U _{ik}^{\lambda}$ terms, and add the $\varepsilon _{i}^{\lambda}$ term into them we get:
\begin{equation}
    -\frac{1}{2}\sum_{ijabk}(T _{ij}^{ab})^{*}T _{kj}^{ab}\Big(Q _{ki}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle km||ig\rangle + (U _{gm}^{\lambda})^{*}\langle kg||im\rangle]\Big)
\end{equation}
Now looking at the $S _{ak}^{\lambda}$ terms:
\begin{align}
    &-\frac{1}{2}\sum_{ijab}\sum_{k}(T _{ij} ^{ab})^{*}\langle kb||ij\rangle S _{ak}^{\lambda} - \frac{1}{2}\sum_{ijab}\sum_{k}T _{ij}^{ab}\langle ij||kb\rangle S _{ak}^{\lambda} \nonumber \\
    =& -\frac{1}{2}\sum_{ijkab}S _{ak}^{\lambda}\Big(\frac{\langle ij||ab\rangle \langle kb||ij\rangle + \langle ab||ij\rangle \langle ij||kb\rangle}{\Delta _{ab}^{ij}}\Big)
\end{align}
\textcolor{blue}{no further simplification for general (complex) orbitals, but could be further simplified if assumed real orbitals}
\\

Now putting these all back into eqn (10):
\begin{align}
    \pdv{E ^{(2)}}{\lambda} =& -\frac{1}{2}\sum_{ijkab}S _{ak}^{\lambda}\Big(T _{ij}^{ab}\langle ij||kb\rangle + (T _{ij}^{ab})^{*}\langle kb||ij\rangle\Big) \nonumber \\
    &- \frac{1}{2}\sum_{ijab}\sum_{f\neq a}(T _{ij}^{ab})^{*}\langle fb||ij\rangle S _{af}^{\lambda} -\frac{1}{2}\sum_{ijab}\sum_{k\neq i}T _{ij}^{ab}\langle kj||ab\rangle S _{ik}^{\lambda}\nonumber \\
    &+\frac{1}{2}\sum_{ijab}\sum_{f}(T _{ij}^{ab})^{*}\langle ab||fi\rangle U _{fi}^{\lambda} + \frac{1}{2}\sum_{ijab}\sum_{f}T _{ij}^{ab}\langle fj||ab\rangle (U _{fi}^{\lambda})^{*} \nonumber \\
    &-\frac{1}{2}\sum_{ijab}\sum_{k}(T _{ij}^{ab})^{*}\langle kb||ij\rangle U _{ak}^{\lambda} - \frac{1}{2}\sum_{ijab}\sum_{k}T _{ij}^{ab}\langle ij||kb\rangle (U _{ak}^{\lambda})^{*} \nonumber \\
    &+ \frac{1}{2}\sum_{ijabf}T _{ij}^{ab}(T _{ij}^{fb})^{*}\Big(Q _{fa}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle fg||am\rangle]\Big) \nonumber \\
    &-\frac{1}{2}\sum_{ijabk}(T _{ij}^{ab})^{*}T _{kj}^{ab}\Big(Q _{ki}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle km||ig\rangle + (U _{gm}^{\lambda})^{*}\langle kg||im\rangle]\Big)
\end{align}

By defining:
\begin{align}
    D _{ki} =& -\frac{1}{2}\sum_{jab}(T _{ij}^{ab})^{*}T _{kj}^{ab} \\
    D _{fa} =& \frac{1}{2}\sum_{ijb}(T _{ij}^{fb})^{*}T _{ij}^{ab} \\
    I _{ik} =& -\frac{1}{2}\sum_{jab}T _{ij}^{ab}\langle kj||ab\rangle \\
    I _{af} =& -\frac{1}{2}\sum_{ijb}(T _{ij}^{ab})^{*}\langle fb||ij\rangle \\
    I _{ak} =& -\frac{1}{2}\sum_{ijb}(T _{ij}^{ab}\langle ij||kb\rangle + (T _{ij}^{ab})^{*}\langle kb||ij\rangle)
\end{align}
the derivative becomes:
\begin{align}
    \pdv{E ^{(2)}}{\lambda} =& \sum_{ak}S _{ak}^{\lambda}I _{ak} + \sum_{a\neq f}S _{af}^{\lambda}I _{af} + \sum_{i\neq k}S _{ik}^{\lambda}I _{ik} \nonumber \\
    &+\sum_{af}D _{fa}Q _{fa}^{\lambda} + \sum_{ik}D _{ki}Q _{ki}^{\lambda} \nonumber \\
    &+ \frac{1}{2}\sum_{ijabf}(T _{ij}^{fb})^{*}\langle fb||ai\rangle U _{ai}^{\lambda} + \frac{1}{2}\sum_{ijabf}T _{ij}^{fb}\langle aj||fb\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    &- \frac{1}{2}\sum_{ijkab}(T _{kj}^{ab})^{*}\langle ib||kj\rangle U _{ai}^{\lambda} - \frac{1}{2}\sum_{ijkab}T _{kj}^{ab}\langle kj||ib\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    &+ \frac{1}{2}\sum_{ijmabfg}T _{mj}^{gb}(T _{mj}^{fb})^{*}U _{ai}^{\lambda}\langle fi||ga\rangle + \frac{1}{2}\sum_{ijmabfg}T _{mj}^{gb}(T _{mj}^{fb})^{*}(U _{ai}^{\lambda})^{*}\langle fa||gi\rangle \nonumber \\
    &- \frac{1}{2}\sum_{ijkmabg}(T _{mj}^{gb})^{*}T _{kj}^{gb}U _{ai}^{\lambda}\langle ki||ma\rangle - \frac{1}{2}\sum_{ijkmabg}(T _{mj}^{gb})^{*}T _{kj}^{gb}(U _{ai}^{\lambda})^{*}\langle ka||mi\rangle \nonumber \\
    =& \sum_{ak}S _{ak}^{\lambda}I _{ak} + \sum_{a\neq f}S _{af}^{\lambda}I _{af} + \sum_{i\neq k}S _{ik}^{\lambda}I _{ik} \nonumber \\
    &+\sum_{af}D _{fa}Q _{fa}^{\lambda} + \sum_{ik}D _{ki}Q _{ki}^{\lambda} \nonumber \\
    &+ \frac{1}{2}\sum_{ijabf}(T _{ij}^{fb})^{*}\langle fb||ai\rangle U _{ai}^{\lambda} + \frac{1}{2}\sum_{ijabf}T _{ij}^{fb}\langle aj||fb\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    &- \frac{1}{2}\sum_{ijkab}(T _{kj}^{ab})^{*}\langle ib||kj\rangle U _{ai}^{\lambda} - \frac{1}{2}\sum_{ijkab}T _{kj}^{ab}\langle kj||ib\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    &+\sum_{fg}\sum_{ai} D _{fg}\langle fi||ga\rangle U _{ai}^{\lambda} + \sum_{fg}\sum_{ai}D _{fg}\langle fa||gi\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    &+\sum_{km}\sum_{ai} D _{km}\langle ki||ma\rangle U _{ai}^{\lambda} + \sum_{km}\sum_{ai}D _{km}\langle ka||mi\rangle(U _{ai}^{\lambda})^{*} \nonumber \\
    =& \sum_{ai}S _{ai}^{\lambda}I _{ai} + \sum_{a\neq b}S _{a}^{\lambda}I _{ab} + \sum_{i\neq j}S _{ij}^{\lambda}I _{ij} + \sum_{ab}D _{ab}Q _{ab}^{\lambda} + \sum_{ij}D _{ij}Q _{ij}^{\lambda} \nonumber \\
    &+\frac{1}{2}\sum_{ai}\sum_{jbc}(T _{ij}^{bc})^{*}\langle bc||ai\rangle U _{ai}^{\lambda} + \frac{1}{2}\sum_{ai}\sum_{jbc}T _{ij}^{bc}\langle aj||bc\rangle (U _{ai} ^{\lambda})^{*} \nonumber \\
    &-\frac{1}{2}\sum_{ai}\sum_{jkb}(T _{kj}^{ab})^{*}\langle ib||kj\rangle U _{ai}^{\lambda} - \frac{1}{2}\sum_{ai}\sum_{jkb}T _{kj}^{ab}\langle kj||ib\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    &+\sum_{ai}\sum_{bc}D _{bc}\langle bi||ca\rangle U _{ai} ^{\lambda} + \sum_{ai}\sum_{bc}D _{bc}\langle ba||ci\rangle(U _{ai}^{\lambda})^{*} \nonumber \\
    &+\sum_{ai}\sum_{jk}D _{jk}\langle ji||ka\rangle U _{ai}^{\lambda} + \sum_{ai}\sum_{jk}D _{jk}\langle ja||ki\rangle (U _{ai}^{\lambda})^{*} \nonumber \\
    =& \sum_{ai}S _{ai}^{\lambda}I _{ai} + \sum_{ab}S _{ab}^{\lambda}I _{ab} + \sum_{ij}S _{ij}^{\lambda}I _{ij} + \sum_{ab}D _{ab}Q _{ab}^{\lambda} + \sum_{ij}D _{ij}Q _{ij}^{\lambda} \nonumber \\
    &+ \text{something like}\sum_{ai}X _{ai}U _{ai}^{\lambda}
\end{align}
\textcolor{red}{$\sum_{a\neq b}$ and $\sum_{i\neq j}$ terms, what about the $a=b$ and $i=j$ terms?} \\
\textcolor{blue}{Should I drop the complex conjugate? but still can't see how to merge $\langle bi||ca\rangle$ and $\langle ba||ci\rangle$ terms hence could not get the same $X _{ai}$ intermediate as in the article.}














\newpage
\section{Some Identities}
From CPHF orthonormality condition:
\begin{equation}
    U _{pq}^{\lambda} + (U _{qp}^{\lambda})^{*} + S _{pq}^{\lambda} = 0
\end{equation}
Consider the spin-orbital (and using $\mathbf{C}(\lambda) = \mathbf{C}(0)\mathbf{U}(\lambda)$):
\begin{align}
    |a \rangle = |\psi _{a}\rangle =& \sum_{\mu}C _{\mu a}(\lambda)|\phi _{\mu}\rangle \nonumber \\
    =& \sum_{\mu}\Big(\sum_{q}C _{\mu q}(0)U _{qa}(\lambda)\Big)|\phi _{\mu}\rangle \nonumber \\
    =& \sum_{\mu}\Big(\sum_{k}C _{\mu k}(0)U _{ka}(\lambda)\Big)|\phi _{\mu}\rangle + \sum_{\mu}\Big(\sum_{f\neq a}C _{\mu f}(0)U _{fa}(\lambda)\Big)|\phi _{\mu}\rangle
\end{align}
\textcolor{red}{Question: Why not include $U _{aa}$  into this sum?} \\
Taking derivative w.r.t. $\lambda$:
\begin{align}
    |a ^{\lambda}\rangle =& \sum_{\mu}\Big(\sum_{k}C _{\mu k}(0)U _{ka}^{\lambda}\Big)|\phi _{\mu}\rangle + \sum_{\mu}\Big(\sum_{f\neq a}C _{\mu f}(0)U _{fa}^{\lambda}\Big)|\phi _{\mu}\rangle \nonumber \\
    &+ \sum_{\mu}\Big(\sum_{k}C _{\mu k}(0)U _{ka}\Big)|\phi _{\mu}^{\lambda}\rangle + \sum_{\mu}\Big(\sum_{f\neq a}C _{\mu f}(0)U _{fa}\Big)|\phi _{\mu}^{\lambda}\rangle
\end{align}
Noticing that $\mathbf{U}(0)=\mathbf{I}$ hence $\sum_{\mu}C _{\mu k}(0)|\phi _{\mu}\rangle = |\psi _{k}\rangle$:
\begin{align}
    |a ^{\lambda}\rangle =& \sum_{k}U _{ka}^{\lambda}|\psi _{k}\rangle + \sum_{f\neq a}U _{fa}^{\lambda}|\psi _{f}\rangle + \sum_{\mu q}C _{\mu _{q}}(0)U _{qa}|\phi _{\mu}^{\lambda}\rangle \nonumber \\
    =& \sum_{k}U _{ka}^{\lambda}|k\rangle + \sum_{f\neq a}U _{fa}^{\lambda}|f\rangle + \sum_{\mu}C _{\mu a}|\mu ^{\lambda}\rangle
\end{align}

Similarly:
\begin{align}
    |i ^{\lambda}\rangle = \sum_{k\neq i}U _{ki}^{\lambda}|k\rangle + \sum_{f}U _{fi}^{\lambda}|f\rangle + \sum_{\mu}C _{\mu i}|\mu ^{\lambda}\rangle
\end{align}

Expression for CPHF coefficients (c.f. Pople et al. 1979): 
\begin{equation}
    U _{fa}^{\lambda} = \frac{1}{\varepsilon _{a}-\varepsilon _{f}}(Q _{fa}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle fg||am\rangle])
\end{equation}
\begin{equation}
    U _{ki}^{\lambda} = \frac{1}{\varepsilon _{i}-\varepsilon _{k}}(Q _{ki}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle fm||ag\rangle + (U _{gm}^{\lambda})^{*}\langle kg||im\rangle])
\end{equation}
\begin{equation}
    \varepsilon _{a}^{\lambda} = Q _{aa}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle am||ag\rangle + (U _{gm}^{\lambda})^{*}\langle ag||am\rangle]
\end{equation}
\begin{equation}
    \varepsilon _{i}^{\lambda} = Q _{ii}^{\lambda} + \sum_{gm}[U _{gm}^{\lambda}\langle im||ig\rangle + (U _{gm}^{\lambda})^{*}\langle ig||im\rangle]
\end{equation}



\newpage

\section{Lagrangian Method}
The MP2 Lagrangian could be written as:
\begin{align}
    \mathcal{L} _{\text{MP2}} =& E _{\text{MP2}} + C _{\text{Bri}} \nonumber \\
    =& E _{\text{HF}} + E _{\text{H}} + C _{\text{Bri}}
\end{align}
in which $E _{\text{H}}$ is the Hylleraas functional, $C _{\text{Bri}}$ is the Brillouin condition. The orthonormality condition is enforced implicitly by the
anti-Hermitian condition on the orbital rotation paramer. 

\subsection{Hartree Fock Energy}
The Hartree-Fock energy has contribution from zeroth- and first-order energies in MP2:
\begin{align}
    E _{\text{HF}} =& E ^{(0)} + E ^{(1)} \nonumber \\
    =& \sum_{i}h _{ii} + \sum_{ij}\langle ij||ij\rangle - \frac{1}{2}\sum_{ij}\langle ij||ij\rangle \nonumber \\
    =& \sum_{i}h _{ii} + \frac{1}{2}\sum_{ij}\langle ij||ij\rangle 
\end{align}

\subsection{Hylleraas Functional}
The Hylleraas functional is defined as:
\begin{align}
    E _{\text{H}} =& \langle \Psi ^{(1)}|\hat{V}-E ^{(1)}|\Phi _{0}\rangle + \langle \Phi _{0}|\hat{V}-E ^{(1)}|\Psi ^{(1)}\rangle + \langle \Psi ^{(1)}|\hat{H}^{(0)}-E ^{(0)}|\Psi ^{(1)}\rangle \nonumber \\
    =& 2 \Re\langle \Psi ^{(1)}|\hat{V}-E ^{(1)}|\Phi _{0}\rangle + \langle \Psi ^{(1)}|\hat{H}^{(0)} - E ^{(0)}|\Psi ^{(1)}\rangle
\end{align}
in which the relevant operators and functions are:
\begin{align}
    \hat{V} - E ^{(1)} =& \frac{1}{4}\sum_{pqrs}\langle pq||rs\rangle \{\hat{p}^{\dagger}\hat{q}^{\dagger}\hat{s}\hat{r}\} \\
    \hat{H}^{(0)} - E ^{(0)} =& \sum_{pq}f _{pq}\{\hat{p}^{\dagger}\hat{q}\} = \sum_{pq}h _{pq}\{\hat{p}^{\dagger}\hat{q}\} + \sum_{pqi}\langle pi||qi\rangle \{\hat{p}^{\dagger}\hat{q}\} \\
    |\Psi ^{(1)}\rangle =& \frac{1}{4}\sum_{ijab}T _{ij}^{ab}|\Phi _{ij}^{ab}\rangle
\end{align}
Therefore the Hylleraas functional could be written as:
\begin{align}
    E _{\text{H}} =& \frac{1}{8} \Re {\sum_{ijab}(T _{ij}^{ab})^{*}\sum_{pqrs}\langle pq||rs\rangle\langle \Phi _{ij}^{ab}|\{\hat{p}^{\dagger}\hat{q}^{\dagger}\hat{s}\hat{r}\}|\Phi _{0}\rangle} \nonumber \\
    &+ \frac{1}{16} \sum_{ijab}(T _{ij}^{ab})^{*}\sum_{klcd} T _{kl}^{cd} \sum_{pq}\langle \Phi _{ij}^{ab}|\{\hat{p}^{\dagger}\hat{q}\}|\Phi _{kl}^{cd}\rangle f _{pq}
\end{align}
First, we need to work out the following expectations:
\begin{align}
    \langle \Phi _{ij}^{ab}|\{\hat{p}^{\dagger}\hat{q}^{\dagger}\hat{s}\hat{r}\}|\Phi _{0}\rangle =& \langle \Phi _{0}|\{\hat{i}^{\dagger}\hat{j}^{\dagger}\hat{b}\hat{a}\}\{\hat{p}^{\dagger}\hat{q}^{\dagger}\hat{s}\hat{r}\}|\Phi _{0}\rangle \\
    \langle \Phi _{ij}^{ab}|\{\hat{p}^{\dagger}\hat{q}\}|\Phi _{kl}^{cd}\rangle =& \langle \Phi _{0}|\{\hat{i}^{\dagger}\hat{j}^{\dagger}\hat{b}\hat{a}\}\{\hat{p}^{\dagger}\hat{q}\}\{\hat{c}^{\dagger}\hat{d}^{\dagger}\hat{l}\hat{k}\}|\Phi _{0}\rangle
\end{align}
Using GWT, the non-zero contributions come from the fully contracted terms:
\begin{align}
    \{\hat{i}^{\dagger}\hat{j}^{\dagger}\hat{b}\hat{a}\}\{\hat{p}^{\dagger}\hat{q}^{\dagger}\hat{s}\hat{r}\} =& \{\wick[sep=0.35em]{\c4{\hat{i}^{\dagger}}\c3{\hat{j}^{\dagger}}\c2{\hat{b}}\c1{\hat{a}}\c1{\hat{p}^{\dagger}}\c2{\hat{q}^{\dagger}}\c3{\hat{s}}\c4{\hat{r}}}\}
    + \{\wick[sep=0.35em]{\c4{\hat{i}^{\dagger}}\c3{\hat{j}^{\dagger}}\c2{\hat{b}}\c1{\hat{a}}\c1{\hat{p}^{\dagger}}\c2{\hat{q}^{\dagger}}\c4{\hat{s}}\c3{\hat{r}}}\}
    + \{\wick[sep=0.35em]{\c4{\hat{i}^{\dagger}}\c3{\hat{j}^{\dagger}}\c1{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c2{\hat{q}^{\dagger}}\c3{\hat{s}}\c4{\hat{r}}}\}
    + \{\wick[sep=0.35em]{\c4{\hat{i}^{\dagger}}\c3{\hat{j}^{\dagger}}\c2{\hat{b}}\c1{\hat{a}}\c2{\hat{p}^{\dagger}}\c1{\hat{q}^{\dagger}}\c4{\hat{s}}\c3{\hat{r}}}\} + \dots \nonumber \\
    =& \delta _{ir}\delta _{js}\delta _{bq}\delta _{ap} + \delta _{is}\delta _{jr}\delta _{bp}\delta _{aq} - \delta _{ir}\delta _{js}\delta _{bp}\delta _{aq} - \delta _{is}\delta _{jr}\delta _{bq}\delta _{ap} + \dots
\end{align}
\begin{align}
   &\{\hat{i}^{\dagger}\hat{j}^{\dagger}\hat{b}\hat{a}\}\{\hat{p}^{\dagger}\hat{q}\}\{\hat{c}^{\dagger}\hat{d}^{\dagger}\hat{l}\hat{k}\} \nonumber \\
   =& \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c5{\hat{q}}\c2{\hat{c}^{\dagger}}\c3{\hat{d}^{\dagger}}\c1{\hat{l}}\c4{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c5{\hat{q}}\c3{\hat{c}^{\dagger}}\c2{\hat{d}^{\dagger}}\c1{\hat{l}}\c4{\hat{k}}}\}  
   +\{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c5{\hat{q}}\c2{\hat{c}^{\dagger}}\c3{\hat{d}^{\dagger}}\c4{\hat{l}}\c1{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c5{\hat{q}}\c3{\hat{c}^{\dagger}}\c2{\hat{d}^{\dagger}}\c4{\hat{l}}\c1{\hat{k}}}\}    \nonumber \\
   &+ \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c4{\hat{q}}\c2{\hat{c}^{\dagger}}\c3{\hat{d}^{\dagger}}\c1{\hat{l}}\c5{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c4{\hat{q}}\c2{\hat{c}^{\dagger}}\c3{\hat{d}^{\dagger}}\c5{\hat{l}}\c1{\hat{k}}}\}
   + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c4{\hat{q}}\c3{\hat{c}^{\dagger}}\c2{\hat{d}^{\dagger}}\c1{\hat{l}}\c5{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c1{\hat{p}^{\dagger}}\c4{\hat{q}}\c3{\hat{c}^{\dagger}}\c2{\hat{d}^{\dagger}}\c5{\hat{l}}\c1{\hat{k}}}\}         \nonumber \\
   &+ \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c3{\hat{p}^{\dagger}}\c1{\hat{q}}\c2{\hat{c}^{\dagger}}\c1{\hat{d}^{\dagger}}\c4{\hat{l}}\c5{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c3{\hat{p}^{\dagger}}\c1{\hat{q}}\c2{\hat{c}^{\dagger}}\c1{\hat{d}^{\dagger}}\c5{\hat{l}}\c4{\hat{k}}}\}
   + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c3{\hat{p}^{\dagger}}\c1{\hat{q}}\c1{\hat{c}^{\dagger}}\c2{\hat{d}^{\dagger}}\c4{\hat{l}}\c5{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c3{\hat{p}^{\dagger}}\c1{\hat{q}}\c1{\hat{c}^{\dagger}}\c2{\hat{d}^{\dagger}}\c5{\hat{l}}\c4{\hat{k}}}\}       \nonumber \\
   &+ \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c2{\hat{p}^{\dagger}}\c1{\hat{q}}\c1{\hat{c}^{\dagger}}\c3{\hat{d}^{\dagger}}\c4{\hat{l}}\c5{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c2{\hat{p}^{\dagger}}\c1{\hat{q}}\c1{\hat{c}^{\dagger}}\c3{\hat{d}^{\dagger}}\c5{\hat{l}}\c4{\hat{k}}}\}
   + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c2{\hat{p}^{\dagger}}\c1{\hat{q}}\c3{\hat{c}^{\dagger}}\c1{\hat{d}^{\dagger}}\c4{\hat{l}}\c5{\hat{k}}}\} + \{\wick[sep=0.35em]{\c5{\hat{i}^{\dagger}}\c4{\hat{j}^{\dagger}}\c3{\hat{b}}\c2{\hat{a}}\c2{\hat{p}^{\dagger}}\c1{\hat{q}}\c3{\hat{c}^{\dagger}}\c1{\hat{d}^{\dagger}}\c5{\hat{l}}\c4{\hat{k}}}\} + \dots            \nonumber \\
   =&\delta _{iq}\delta _{jk}\delta _{bd}\delta _{ac}\delta _{pl} - \delta _{iq}\delta _{jk}\delta _{bc}\delta _{ad}\delta _{pl} - \delta _{iq}\delta _{jl}\delta _{bd}\delta _{ac}\delta _{pk} +\delta _{iq}\delta _{jl}\delta _{bc}\delta _{ad}\delta _{pk} \nonumber \\
   &- \delta _{ik}\delta _{jq}\delta _{bd}\delta _{ac}\delta _{pl} + \delta _{il}\delta _{jq}\delta _{bd}\delta _{ac}\delta _{pk} +\delta _{ik}\delta _{jq}\delta _{bc}\delta _{ad}\delta _{pl} - \delta _{il}\delta _{jq}\delta _{bc}\delta _{ad}\delta _{pk} \nonumber \\ 
   &+ \delta _{ik}\delta _{jl}\delta _{bp}\delta _{ac}\delta _{qd} -\delta _{il}\delta _{jk}\delta _{bp}\delta _{ac}\delta _{qd} - \delta _{ik}\delta _{jl}\delta _{bp}\delta _{ad}\delta _{qc} + \delta _{il}\delta _{jk}\delta _{bp}\delta _{ad}\delta _{qc} \nonumber \\
   &+\delta _{ik}\delta _{jl}\delta _{bd}\delta _{ap}\delta _{qc} - \delta _{il}\delta _{jk}\delta _{bd}\delta _{ap}\delta _{qc} - \delta _{ik}\delta _{jl}\delta _{bc}\delta _{ap}\delta _{qd} +\delta _{il}\delta _{jk}\delta _{bc}\delta _{ap}\delta _{qd} + \dots
\end{align}
the terms not fully contrated are ommitted.\\
Therefore, the two parts of Hylleraas functional could be simplified as:
\begin{align}
    &\frac{1}{8}\Re{\sum_{ijab}(T _{ij}^{ab})^{*}\sum_{pqrs}\langle pq||rs\rangle\langle \Phi _{ij}^{ab}|\{\hat{p}^{\dagger}\hat{q}^{\dagger}\hat{s}\hat{r}\}|\Phi _{0}\rangle} \nonumber \\
    =& \frac{1}{8}\Re{\sum_{ijab}(T _{ij}^{ab})^{*}(\langle ab||ij\rangle + \langle ba||ji\rangle - \langle ba||ij\rangle - \langle ab||ji\rangle)} \nonumber \\
    =& \frac{1}{2}\Re{\sum_{ijab}(T _{ij}^{ab})^{*}\langle ab||ij\rangle}
\end{align}
\begin{align}
    &\frac{1}{16}\sum_{ijab}(T _{ij}^{ab})^{*}\sum_{klcd}T _{kl}^{cd}\sum_{pq}\langle \Phi _{ij}^{ab}|\{\hat{p}^{\dagger}\hat{q}\}|\Phi _{kl}^{cd}\rangle f _{pq} \nonumber \\
    =& \frac{1}{16}\Big(\sum_{ijlab}f _{li}(T _{ij}^{ab})^{*}T _{jl}^{ab} - \sum_{ijlab}f _{li}(T _{ij}^{ab})^{*}T _{jl}^{ba} - \sum_{ijkab}f _{ki}(T _{ij}^{ab})^{*}T _{kj}^{ab} + \sum_{ijkab}f _{ki}(T _{ij}^{ab})^{*}T _{kj}^{ba} \nonumber \\
    & -\sum_{ijlab}f _{lj}(T _{ij}^{ab})^{*}T _{il}^{ab} + \sum_{ijlab}f _{lj}(T _{ij}^{ab})^{*}T _{il}^{ba} + \sum_{ijkab}f _{kj}(T _{ij}^{ab})^{*}T _{ki}^{ab} - \sum_{ijkab}f _{kj}(T _{ij}^{ab})^{*}T _{ki}^{ba} \nonumber \\
    & +\sum_{ijabd}f _{bd}(T _{ij}^{ab})^{*}T _{ij}^{ad} - \sum_{ijabd}f _{bd}(T _{ij}^{ab})^{*}T _{ji}^{ad} - \sum_{ijabc}f _{bc}(T _{ij}^{ab})^{*}T _{ij}^{ca} + \sum_{ijabc}f _{bc}(T _{ij}^{ab})^{*}T _{ji}^{ca} \nonumber \\
    & +\sum_{ijabc}f _{ac}(T _{ij}^{ab})^{*}T _{ij}^{cb} - \sum_{ijabc}f _{ac}(T _{ij}^{ab})^{*}T _{ji}^{cb} - \sum_{ijabd}f _{ad}(T _{ij}^{ab})^{*}T _{ij}^{bd} + \sum_{ijabd}f _{ad}(T _{ij}^{ab})^{*}T _{ji}^{bd}\Big) \nonumber \\
    =& \frac{1}{4}\Big(\sum_{ijkab}f _{ki}(T _{ij}^{ab})^{*}T _{jk}^{ab} - \sum_{ijkab}f _{ki}(T _{ji}^{ab})^{*}T _{jk}^{ab} + \sum_{ijabc}f _{ac}(T _{ij}^{ba})^{*}T _{ij}^{bc} - \sum_{ijabc}f _{ac}(T _{ij}^{ab})^{*}T _{ij}^{bc}\Big) \nonumber \\
    =& \frac{1}{2}\Big(\sum_{ijkab}f _{ki}(T _{ij}^{ab})^{*}T _{jk}^{ab} - \sum_{ijabc}f _{ac}(T _{ij}^{ab})^{*}T _{ij}^{bc}\Big)
\end{align}
Therefore, the Hylleraas functional, written in spin-orbital form, is:
\begin{equation}
    E _{\text{H}} = \frac{1}{2}\Re{\sum_{ijab}(T _{ij}^{ab})^{*}\langle ab||ij\rangle} +  \frac{1}{2}\Big(\sum_{ijkab}f _{ki}(T _{ij}^{ab})^{*}T _{jk}^{ab} - \sum_{ijabc}f _{ac}(T _{ij}^{ab})^{*}T _{ij}^{bc}\Big)
\end{equation} 
To formulate the Hylleraas functional into density matrix representation, we write out dependencies on one- and two-electron integrals, i.e., $h _{pq}$ and $\langle pq||rs\rangle$ explicitly.
\begin{align}
    E _{\text{H}} =& \frac{1}{2}\Re{\sum_{ijab}(T _{ij}^{ab})^{*}\langle ab||ij\rangle} + \frac{1}{2}\Big(\sum_{ijkab}h _{ki}(T _{ij}^{ab})^{*}T _{jk}^{ab} - \sum_{ijabc}h _{ac}(T _{ij}^{ab})^{*}T _{ij}^{bc} \Big) \nonumber \\
    &+ \frac{1}{2}\Big(\sum_{ijklab}\langle kl||il\rangle (T _{ij}^{ab})^{*}T _{jk}^{ab} - \sum_{ijkabc}\langle ak||ck\rangle (T _{ij}^{ab})^{*}T _{ij}^{bc} \Big) \nonumber \\
    =& \sum_{ij} h _{ij} \gamma _{ij} + \sum_{ab}h _{ab}\gamma _{ab} + \sum_{ijab}\Re{\langle ab||ij\rangle \Gamma _{ij}^{ab}} + \sum_{ijkl}\langle ij||kl\rangle \Gamma _{kl}^{ij} + \sum_{ijab}\langle ai||bj\rangle \Gamma _{bj}^{ai}
\end{align}
in which
\begin{align}
    \gamma _{ij} =& \frac{1}{2}\sum_{kab}(T _{jk}^{ab})^{*}T _{ki}^{ab} \\
    \gamma _{ab} =& -\frac{1}{2}\sum_{ijc}(T _{ij}^{ac})^{*}T _{ij}^{cb} \\
    \Gamma _{ij}^{ab} =& \frac{1}{2}(T _{ij}^{ab})^{*} \\
    \Gamma _{kl}^{ij} =& \frac{1}{2}\sum_{mab}(T _{km}^{ab})^{*}T _{mi}^{ab}\delta _{jl} \\
    \Gamma _{bj}^{ai} =& -\frac{1}{2}\sum_{klc}(T _{kl}^{ac})^{*}T _{kl}^{cb} \delta _{ij}
\end{align}

\subsection{Perturbed Orthonormality Condition}
We have the general orthonormality condition, subject to perturbation, as:
\begin{equation}
    S _{pq}=\langle p|q\rangle = \delta _{pq}
\end{equation}
\begin{equation}
    \sum_{\mu \nu}C _{\mu p}^{*}S _{\mu \nu}C _{\nu q} = \delta _{pq}
\end{equation}
Parameterization of the MO coefficients:
\begin{equation}
    \mathbf{C}(\lambda) = \mathbf{C}(0)\mathbf{U}(\lambda)
\end{equation}
\begin{equation}
    C _{\mu p}(\lambda) = \sum_{r}C _{\mu r}(0)U _{rp}(\lambda)
\end{equation}
in which $\mathbf{U}(\lambda)$ is the solution to the CPHF equations.
\\

Now the orthonormality condition using this parameterization:
\begin{equation}
    \sum_{\mu \nu}\Big(\sum_{r}U _{rp}^{*}(\lambda)C _{\mu r}^{*}(0)\Big)S _{\mu \nu}(\lambda)\Big(\sum_{s}C _{\nu s}(0)U _{sq}(\lambda)\Big) = \delta _{pq}
\end{equation}
Introducing the transformed overlap matrix:
\begin{equation}
    \mathcal{S} _{pq}(\lambda) = \sum_{\mu \nu}C _{\mu p}^{*}(0)S _{\mu \nu}(\lambda)C _{\nu q}(0)
\end{equation}
we have:
\begin{equation}
    \sum_{rs}U _{rp}^{*}(\lambda)\mathcal{S}_{rs}(\lambda)U _{sq}(\lambda) = \delta _{pq}
\end{equation}
differentiating both sides of the equation gives:
\begin{equation}
    \sum_{rs}\frac{\dd{U _{rp}^{*}(\lambda)}}{\dd{\lambda}}\mathcal{S}_{rs}(\lambda)U _{sq}(\lambda) + \sum_{rs}U _{rp}^{*}(\lambda)\frac{\dd{\mathcal{S}_{rs}(\lambda)}}{\dd{\lambda}}U _{sq}(\lambda) + \sum_{rs}U _{rp}^{*}(\lambda)\mathcal{S}_{rs}(\lambda)\frac{\dd{U _{sq}(\lambda)}}{\dd{\lambda}} = 0
\end{equation}
Noting that $\bm{\mathcal{S}}(0)=\mathbf{I}$ because the unperturbed spin-orbitals are orthonormal, and it is trivial that $\mathbf{U}(0)=\mathbf{I}$. \\
Therefore evaluating the derivative at $\lambda = 0$, and denoting $A ^{\lambda} =\big(\frac{\dd{A}}{\dd{\lambda}}\big)\big|_{{\lambda=0}}$ results in:
\begin{align}
    \sum_{rs}(U _{rp}^{\lambda})^{*}\delta _{rs}\delta _{sq} + \sum_{rs}\delta _{rp}\mathcal{S}_{rs}^{\lambda}\delta _{sq} + \sum_{rs}\delta _{rp}\delta _{rs}U _{sq}^{\lambda} = 0
\end{align}
contracting the Kronecker delta tensors we get the perturbed orthonormality condition:
\begin{equation}
    (U _{qp}^{\lambda})^{*} + \mathcal{S}_{pq}^{\lambda} + U _{pq}^{\lambda} = 0
\end{equation}

\subsection{Perturbed Brillouin Condition}
The SCF density matrix is defined as:
\begin{equation}
    D _{\mu \nu}^{\text{SCF}} = \sum_{i}^{N} C _{\mu i}^{*}C _{\nu i}
\end{equation}
in which the MO coefficients are parameterized as:
\begin{align}
    C _{\mu p}(\lambda) =& \sum_{q} C _{\mu q}(0)U(\lambda)_{qp} \\
    \mathbf{C}(\lambda) =& \mathbf{C}(0)\mathbf{U}(\lambda)
\end{align}


Define the one- and two-electron parts of the fock matrix, in AO and MO basis, as:
\begin{equation}
    \begin{aligned}[t]
     h _{pq}=& \langle p|\hat{h}|q\rangle
     = \sum_{\mu \nu}C _{\mu p}^{*}h _{\mu \nu}^{\text{AO}}C _{\nu q}\\
     h _{\mu \nu} ^{\text{AO}}=& \langle \mu|\hat{h}|\nu\rangle \\
    \mathbf{h} =& \mathbf{C}^{\dagger}\mathbf{h}^{\text{AO}}\mathbf{C} \\
    \end{aligned}
    \qquad 
    \begin{aligned}[t]
     g _{pq}=& \sum_{i}\langle pi||qi\rangle
     = \sum_{i}\sum_{\mu \nu}C _{\mu p}^{*}\langle \mu i||\nu i\rangle C _{\nu q}\\
     g _{\mu \nu}^{\text{AO}}=& \sum_{i}\langle \mu i||\nu i\rangle
     = \sum_{\rho \sigma}D _{\rho \sigma}\langle \mu \rho||\nu \sigma\rangle \\
    \mathbf{g} =& \mathbf{C}^{\dagger}\mathbf{g}^{\text{AO}}\mathbf{C} \\
    \end{aligned}
\end{equation}
Therefore, the Fock matrix could be expressed as (with the dependency on SCF density explicitly addressed):
\begin{align}
    f _{pq} =& h _{pq} + \sum_{i}\langle pi||qi\rangle \nonumber \\
    =& \sum_{\mu \nu}C _{\mu p}^{*}h _{\mu \nu}^{\text{AO}}C _{\nu q} + \sum_{\mu \nu}C _{\mu p}^{*} g _{\mu \nu}^{\text{AO}} C _{\nu q} \nonumber \\
    =& \sum_{\mu \nu}C _{\mu p}^{*}\langle \mu|\hat{h}|\nu\rangle C _{\nu q} + \sum_{\mu \nu}C _{\mu p}^{*}\big(\sum_{\rho \sigma} D _{\rho \sigma}\langle \mu \rho||\nu \sigma\rangle\big)C _{\nu q} \\
    f ^{\text{AO}}_{\mu \nu} =& h _{\mu \nu}^{\text{AO}} + g ^{\text{AO}}_{\mu \nu} = \langle \mu|\hat{h}|\nu\rangle + \sum_{\rho \sigma}D _{\rho \sigma}\langle \mu \rho||\nu \sigma\rangle \\
    \mathbf{f}=& \mathbf{h} + \mathbf{g}[\mathbf{D}^{\text{SCF}}] \nonumber \\
    =& \mathbf{C}^{\dagger}\mathbf{h}^{\text{AO}}\mathbf{C} + \mathbf{C}^{\dagger}\mathbf{g}^{\text{AO}}[\mathbf{D}^{\text{SCF}}]\mathbf{C} \nonumber \\
    =& \mathbf{C}^{\dagger}\mathbf{F}^{\text{AO}}[\mathbf{D}^{\text{SCF}}]\mathbf{C} \\
    \mathbf{f}^{\text{AO}}[\mathbf{D}^{\text{SCF}}] =& \mathbf{h}^{\text{AO}} + \mathbf{g}^{\text{AO}}[\mathbf{D}^{\text{SCF}}]
\end{align}
Evaluating the derivative at $\lambda = 0$, noting that $\mathbf{U}(0) = \mathbf{I}$:
\begin{align}
    \mathbf{f}^{\lambda} =& \frac{\dd{\mathbf{f}(\lambda)}}{\dd{\lambda}}\Big|_{{\lambda = 0}} = \Big(\mathbf{C}^{\dagger}(\lambda)\mathbf{f}^{\text{AO}}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda)\mathbf{C}(\lambda)\Big)^{\lambda} \nonumber \\
    =&\mathbf{C}^{\lambda \dagger}(\lambda)\mathbf{f}^{\text{AO}}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda)\mathbf{C}(\lambda) + \mathbf{C}^{\dagger}(\lambda)\mathbf{f}^{\text{AO}}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda)\mathbf{C}^{\lambda}(\lambda) \nonumber \\
    &+ \mathbf{C}^{\dagger}(\lambda) \Big(\mathbf{h}^{\text{AO}}(\lambda) + \mathbf{g}^{\text{AO}}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda)\Big)^{\lambda} \mathbf{C}(\lambda)  \nonumber \\
    =& \mathbf{U}^{\lambda \dagger}(\lambda)\underbrace{\mathbf{U}^{\dagger}(0)\mathbf{C}^{\dagger}(0)}_\text{$\mathbf{C}^{\dagger}(\lambda = 0)$}\mathbf{f}^{\text{AO}}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda)\mathbf{C}(\lambda) + \mathbf{C}^{\dagger}(\lambda)\mathbf{f}^{\text{AO}}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda)\underbrace{\mathbf{C}(0)\mathbf{U}(0)}_\text{$\mathbf{C}(\lambda = 0)$}\mathbf{U}^{\lambda}(\lambda) \nonumber \\
    &+ \mathbf{C}^{\dagger}(\lambda)\Big(\mathbf{h}^{\text{AO},\lambda}(\lambda) + \mathbf{g}^{\text{AO}, \lambda}[\mathbf{D}^{\text{SCF}}(\lambda)](\lambda) + \mathbf{g}^{\text{AO}}[\mathbf{D}^{\text{SCF},\lambda}(\lambda)](\lambda)\Big)\mathbf{C}(\lambda) \nonumber \\
    =& \mathbf{U}^{\lambda \dagger}\mathbf{f} + \mathbf{f}\mathbf{U}^{\lambda} + \mathbf{C}^{\dagger}\mathbf{h}^{\text{AO}, \lambda}\mathbf{C}
    + \mathbf{C}^{\dagger}\mathbf{g}^{\text{AO},\lambda}[\mathbf{D}^{\text{SCF}}]\mathbf{C} + \mathbf{C}^{\dagger}\mathbf{g}^{\text{AO}}[\mathbf{D}^{\text{SCF},\lambda}]\mathbf{C}
\end{align}
The perturbed Brillouin condition is:
\begin{equation}
    f _{ai}^{\lambda} = 0
\end{equation}
To evaluate the perturbed Fock matrix, we write the perturbed quantities in suffix notation as (assuming canonical orbitals, i.e. $f _{pq} = \delta _{pq}\varepsilon _{p}$):
\begin{align}
    (\mathbf{U}^{\lambda \dagger}\mathbf{f}) _{ai} =& U ^{\lambda *}_{ia}\varepsilon _{i} = \frac{\dd{U _{ia}^{*}}}{\dd{\lambda}}\Big|_{{\lambda = 0}}\varepsilon _{i} \\
    (\mathbf{f}\mathbf{U}^{\lambda})_{ai} =& \varepsilon _{a}U _{ai}^{\lambda} = \varepsilon _{a}\frac{\dd{U _{ai}}}{\dd{\lambda}}\Big|_{{\lambda=0}} \\
    (\mathbf{C}^{\dagger}\mathbf{h}^{\text{AO},\lambda}\mathbf{C})_{ai}=&\sum_{\mu \nu}C _{\mu a}^{*}h _{\mu \nu}^{\lambda} C _{\nu i} = \sum_{\mu \nu}C _{\nu a}^{*}\frac{\dd{h _{\mu \nu}}}{\dd{\lambda}}\Big|_{{\lambda=0}}C _{\nu i} \\
    (\mathbf{C}^{\dagger}\mathbf{g}^{\text{AO}, \lambda}[\mathbf{D}^{\text{SCF}}]\mathbf{C})_{ai} =& \sum_{\mu \nu}C _{\mu a}^{*}(\sum_{\rho \sigma}D _{\rho \sigma}\langle \mu \rho||\nu \sigma\rangle ^{\lambda})C _{\nu i} \nonumber \\
    =& \sum_{\mu \nu}C _{\mu a}^{*}(\sum_{\rho \sigma}D _{\rho \sigma}\frac{\dd{\langle \mu \rho||\nu \sigma\rangle}}{\dd{\lambda}}\Big|_{{\lambda=0}})C _{\nu i} \\
    (\mathbf{C}^{\dagger}\mathbf{g}^{\text{AO}}[\mathbf{D}^{\text{SCF},\lambda}]\mathbf{C})_{ai} =& \sum_{\mu \nu}C _{\mu a}^{*}(\sum_{\rho \sigma}D _{\rho \sigma}^{\lambda}\langle \mu \rho||\nu \sigma\rangle)C _{\nu i} \nonumber \\
    =& \sum_{\mu \nu} C _{\mu a}^{*}(\sum_{\rho \sigma}\frac{\dd{D}_{\rho \sigma}}{\dd{\lambda}}\Big|_{{\lambda=0}}\langle \mu \rho||\nu \sigma\rangle)C _{\nu i}
\end{align}




\newpage
\subsection{Z-Vector Equation (Matrix Parameterization)}
Imposing the stationary condition on the Lagrangian w.r.t. the orbital rotation parameter:
\\
(Usually take the linear combination of $f _{ai}$ and $f _{ia}^{*}$ to make the Lagrangian real, and remember that the fock matrix is Hermitian.)
\\
\textcolor{red}{In Matrix Parameterization, $C _{\text{ON}}$ is required!}
\begin{align}
    \mathcal{L} _{\text{MP2}} =& E _{\text{HF}} + E _{\text{H}} + \sum_{ai}z _{ai}f _{ai} \nonumber \\
    =& \sum_{pq}h _{pq}\gamma _{pq} + \sum_{pqrs}\Gamma _{rs}^{pq}\langle pq||rs\rangle + \sum_{ai}z _{ai}f _{ai} \nonumber \\
    =& \sum_{pq}h _{pq}\gamma _{pq}^{\text{HF}} + \sum_{pqrs}(\Gamma ^{pq}_{rs})^{\text{HF}}\langle pq||rs\rangle \nonumber \\
     &+ \sum_{pq}h _{pq}\gamma _{pq}^{\text{H}}+ \sum_{pqrs} (\Gamma _{rs}^{pq})^{\text{H}}\langle pq||rs\rangle + \sum_{ai}z _{ai}f _{ai}\\
    \pdv{\mathcal{L} _{\text{MP2}}}{\mathbf{U}} =& \pdv{E _{\text{HF}}}{\mathbf{U}} + \pdv{E _{\text{H}}}{\mathbf{U}} + \sum_{ai}z _{ai}\pdv{f _{ai}}{\mathbf{U}} = 0
\end{align}
The Hylleraas part (assuming real):
\begin{align}
    E _{\text{H}} =& \sum_{ij}h _{ij}\gamma _{ij} + \sum_{ab}h _{ab}\gamma _{ab} + \sum_{ijab}\langle ab||ij\rangle \Gamma _{ij}^{ab} + \sum_{ijkl}\langle ij||kl\rangle \Gamma _{kl}^{ij} + \sum_{ijab}\langle ai||bj\rangle \Gamma _{bj}^{ai}
\end{align}
\textcolor{red}{Which blocks of $\mathbf{U}$ should be considered?}
\\
\textcolor{blue}{In general, all of them! But some will come out to be redundant and the ones contribute are the virtual-occupied blocks.}
\\
Also, need to take linear combination of $\pdv{U _{pq}}$ and $\pdv{U _{qp}^{*}}$ to get rid of the Lagrange multilpier in $C _{\text{ON}}$ condition.\\
Could treat $\mathbf{U}$ and $\mathbf{U}^{*}$ as independent variables, i.e.:
\begin{equation}
    \pdv{U _{pq}}{U ^{*}_{rs}} = 0
\end{equation} 
Or just treat real and imaginary parts separately.
\begin{align}
   \pdv{h _{ij}}{U _{pq}} =& \pdv{U _{pq}}\sum_{\mu \nu}C _{\mu i}^{*}h _{\mu \nu}C _{\nu j} \nonumber \\
   =& \pdv{U _{pq}}\sum_{\mu \nu rs}C ^{*}_{\mu r}(0)U _{ri}^{*}h _{\mu \nu}C _{\nu s}(0)U _{s j} \nonumber \\
   =& \sum_{\mu \nu r}C _{\mu r}^{*}(0)\pdv{U ^{*} _{ri}}{U _{pq}}h _{\mu \nu}C _{\nu j} + \sum_{\mu \nu r}C _{\mu i}^{*}h _{\mu \nu}C _{\nu r}(0)\pdv{U _{rj}}{U _{pq}} \nonumber \\
   =& 0 + \sum_{\mu \nu r}C _{\mu i}^{*}h _{\mu \nu}C _{\nu r}(0)\delta _{pr}\delta _{qj} \nonumber \\
   =& \sum_{\mu \nu}C _{\mu i}^{*}h _{\mu \nu}C _{\nu p}(0)\delta _{qj}
\end{align}
Similarly:
\begin{align}
    \pdv{h _{ab}}{U _{pq}} = \sum_{\mu \nu r}C _{\mu r}^{*}(0)(\pdv{U _{ra}}{U _{pq}})^{*}h _{\mu \nu}C _{\nu b} + \sum_{\mu \nu r}C _{\mu a}^{*}h _{\mu \nu}C _{\nu r}(0)\pdv{U _{rb}}{U _{pq}}
\end{align}
\begin{align}
    \pdv{\langle ab||ij\rangle}{U _{pq}} =& \pdv{U _{pq}}\sum_{\mu \nu \sigma \tau}C _{\mu a}^{*}C _{\nu b}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma i}C _{\tau j} \nonumber \\
    =& \sum_{\mu \nu \sigma \tau r} C ^{*}_{\mu r}(0)(\pdv{U _{ra}}{U _{pq}})^{*}C _{\nu b}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma i}C _{\tau j} \nonumber \\
    &+ \sum_{\mu \nu \sigma \tau r} C _{\mu a}^{*}C ^{*} _{\nu r}(0)(\pdv{U _{rb}}{U _{pq}})^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma i}C _{\tau j} \nonumber \\
    &+ \sum_{\mu \nu \sigma \tau r} C _{\mu a}^{*}C _{\nu b}^{*}\langle \mu \nu||\sigma \tau \rangle C _{\sigma r}(0)\pdv{U _{r i}}{U _{pq}}C _{\tau j} \nonumber \\
    &+ \sum_{\mu \nu \sigma \tau r} C _{\mu a}^{*}C _{\nu b}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma i}C _{\tau r}(0)\pdv{U _{rj}}{U _{pq}}
\end{align}
Other blocks of the 2e-integrals are similar.\\
note:
\begin{equation}
    \dv{U _{pq}}{U _{rs}} = \delta _{pr}\delta _{qs}
\end{equation}

Now the Brillouin part:
\begin{align}
    \pdv{f _{ai}}{U _{pq}} =& \pdv{U _{pq}}(h _{ai} + \sum_{j}\langle aj||ij\rangle)
\end{align}
The constituent parts have been worked out from above.





\subsection{Z-Vector Equation (Exponential Parameterization)}
\begin{align}
    \mathbf{U} =& \exp(-\bm{\kappa}) \nonumber \\
    =& \sum_{n=0}^{\infty}(-1)^{n}\frac{\bm{\kappa}^{n}}{n!}
\end{align}
The orbital rotation parameter $\bm{\kappa}$ is anti-Hermitian:
\begin{equation}
    \bm{\kappa}^{\dagger} = (\bm{\kappa}^{*})^{T} = -\bm{\kappa}
\end{equation}
Therefore the matrix $\mathbf{U}$ is unitary:
\begin{equation}
    \mathbf{U}^{\dagger}\mathbf{U} = \exp(-\bm{\kappa}^{\dagger})\exp(-\bm{\kappa}) = \exp(\bm{\kappa})\exp(-\bm{\kappa}) = \mathbf{I}
\end{equation}
Let the matrix $\mathbf{U}$ be the parameter in CPSCF:
\begin{align}
    \mathbf{C}(\lambda) =& \mathbf{C}(0)\mathbf{U}(\lambda) = \mathbf{C}(0)\exp[-\bm{\kappa}(\lambda)] \\
    C _{\mu p}(\lambda) =& \sum_{r} C _{\mu r}(0)U _{rp}(\lambda) = \sum_{r}C _{\mu r}(0)(\exp[-\bm{\kappa}(\lambda)])_{rp} \\
    [\exp(-\bm{\kappa})]_{rp}=& (\mathbf{I}-\bm{\kappa} + \frac{1}{2!}\bm{\kappa}^{2}-\frac{1}{3!}\bm{\kappa}^{3} + \dots)_{rp} \nonumber \\
    =&\delta _{rp} - \kappa_{rp} + \frac{1}{2!}\sum_{x}k _{rx}k _{xp} - \frac{1}{3!}\sum_{xy}k _{rx}k _{xy}k_{yp} + \dots
\end{align} 
The orthonormality condition is enforced explicitly in matrix parameterization, while in exponential parameterization it comes naturally from the anti-Hermitian property of $\bm{\kappa}$:
\begin{align}
    \mathbf{C}^{\dagger}(\lambda)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(\lambda) =& (\mathbf{C}(0)\exp[-\bm{\kappa}(\lambda)])^{\dagger}\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(0)\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =&\exp[-\bm{\kappa}^{\dagger}(\lambda)]\underbrace{\mathbf{C}^{\dagger}(0)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(0)}_{=\mathbf{I}}\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \exp[\bm{\kappa}(\lambda)]\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \mathbf{I}
\end{align}
\textcolor{red}{NO! Take derivatives!:}
\begin{align}
    \mathbf{I} =& \mathbf{S}(\lambda) \nonumber \\
    =& \mathbf{C}^{\dagger}(\lambda)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(\lambda) \nonumber \\
    =& (\mathbf{C}(0)\exp[-\bm{\kappa}(\lambda)])^{\dagger}\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(0)\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \exp[-\bm{\kappa}^{\dagger}(\lambda)]\mathbf{C}^{\dagger}(0)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(0)\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \exp[\bm{\kappa}(\lambda)]\bm{\mathcal{S}}(\lambda)\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \Big[\mathbf{I} + \bm{\kappa}(\lambda) + \frac{1}{2}\bm{\kappa}^{2}(\lambda) + \dots\Big]\bm{\mathcal{S}}(\lambda)\Big[\mathbf{I}-\bm{\kappa}(\lambda)+\frac{1}{2}\bm{\kappa}^{2}(\lambda)+ \dots\Big] \\
    \Leftrightarrow \delta _{pq} =& \sum_{\mu \nu} C _{\mu p}^{*}(\lambda)S _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu q}(\lambda) \nonumber \\
    =& \sum_{\mu \nu}\big(\sum_{r}C _{\mu r}^{*}(0)\exp[-\bm{\kappa}(\lambda)]^{*}_{rp}\big)S ^{\text{AO}}_{\mu \nu}(\lambda)\big(\sum_{s}C _{\nu s}\exp[-\bm{\kappa}(\lambda)]_{sq}\big) \nonumber \\
    =& \sum_{\mu \nu rs}\exp[\bm{\kappa}(\lambda)]_{pr}\big(C ^{*}_{\mu r}(0)S ^{\text{AO}}_{\mu \nu}(\lambda)C _{\nu s}(0)\big)\exp[-\bm{\kappa}(\lambda)]_{sq} \nonumber \\
    =& \sum_{rs}\exp[\bm{\kappa}(\lambda)]_{pr}\mathcal{S} _{rs}(\lambda)\exp[-\bm{\kappa}(\lambda)]_{sq} \nonumber \\
    =& \sum_{rs}\Big[\delta _{pr} + \kappa _{pr}(\lambda) + \frac{1}{2}\sum_{x}\kappa _{px}(\lambda)\kappa _{xr}(\lambda)\Big]\mathcal{S} _{rs}(\lambda)\Big[\delta _{sq} + \kappa _{sq}(\lambda) + \frac{1}{2}\sum_{y}\kappa _{sy}(\lambda)\kappa _{yq}(\lambda)\Big]
\end{align}
\textcolor{orange}{index $x$ \& $y$ look weird, find other appropriate indices.}\\
For derivative of ON condition, only first order expansion is needed.
\begin{align}
    \delta _{pq} =& \sum_{rs}\big[\delta _{pr} + \kappa _{pr}(\lambda)\big]\mathcal{S} _{rs}(\lambda)\big[\delta _{sq} + \kappa _{sq}(\lambda)\big] \nonumber \\
    =& \sum_{rs}\delta _{pr}\mathcal{S} _{rs}(\lambda)\delta _{sq} + \sum_{rs}\kappa _{pr}(\lambda)\mathcal{S} _{rs}(\lambda)\kappa _{sq}(\lambda) \nonumber \\
    =& \mathcal{S} _{pq}(\lambda) + \sum_{rs}\kappa _{pr}(\lambda)\mathcal{S}_{rs}(\lambda)\kappa _{sq}(\lambda)
\end{align}
Taking derivative w.r.t. perturbation on both sides (noting that $\bm{\mathcal{S}}(0) =\mathbf{I}$ ):
\begin{align}
    0 =& \pdv{\mathcal{S} _{pq}(\lambda)}{\lambda}\Big|_{{\lambda=0}} + \sum_{rs}\pdv{\kappa _{pr}(\lambda)}{\lambda}\Big|_{{\lambda=0}}\mathcal{S} _{sr}(\lambda)\kappa _{sq}(\lambda) + \sum_{rs}\kappa _{pr}(\lambda)\mathcal{S} _{rs}\pdv{\kappa _{sq}(\lambda)}{\lambda}\Big|_{{\lambda=0}} \nonumber \\
    =& \mathcal{S} _{pq}^{\lambda} + \sum_{rs}\kappa _{pr}^{\lambda}\delta _{sr}\kappa _{sq}+ \sum_{rs}\kappa _{pr}\delta _{rs}\kappa _{sq}^{\lambda} \nonumber \\
    =& \mathcal{S} _{pq}^{\lambda} + \sum_{r}\kappa _{pr}^{\lambda}\kappa _{rq} + \sum_{r}\kappa _{pr}\kappa _{rq}^{\lambda} \nonumber \\
    =& \mathcal{S} _{pq}^{\lambda} + \sum_{r}(-\kappa _{rp}^{\lambda *})(-\kappa _{qr}^{*}) + \sum_{r}\kappa _{pr}\kappa _{rq}^{\lambda} \nonumber \\
    =& \mathcal{S} _{pq}^{\lambda} + \sum_{r}\kappa _{qr}^{*}\kappa _{rp}^{\lambda *} + \sum_{r}\kappa _{pr}\kappa _{rq}^{\lambda}
\end{align}
\\
Now to impose the stationary condition: (only taking up to second derivative, so could truncate $\mathbf{\kappa}$ series up to quadratic term.
\textcolor{blue}{Could also just use BCH, if that's better for the code generator})
\begin{align}
    \pdv{\mathcal{L}_{\text{MP2}}}{\bm{\kappa}} =& \pdv{E _{\text{HF}}}{\bm{\kappa}} + \pdv{E _{\text{H}}}{\bm{\kappa}} + \sum_{ai}z _{ai}\pdv{f _{ai}}{\bm{\kappa}} =0 \\
    \pdv{E _{\text{HF}}}{\bm{\kappa}} =&        \\
    \pdv{E _{\text{H}}}{\bm{\kappa}} =&         \\
    \pdv{f _{ai}}{\bm{\kappa}} =&               
\end{align}
The specific blocks:
\begin{align}
    \pdv{h _{pq}}{\kappa _{rs}} =& \pdv{\kappa _{rs}}\sum_{\mu \nu}C _{\mu p}^{*}h _{\mu \nu}C _{\nu q} \nonumber \\
    =& \pdv{\kappa _{rs}}\sum_{\mu \nu}
\end{align}





\subsection{Z-Vector Equation (Improved Exponential Parameterization)}
\begin{align}
    \mathbf{C}(\lambda) =& \mathbf{C}(0)\mathbf{U}(\lambda) \\
    \mathbf{U}(\lambda) =& \bm{\mathcal{S}}^{-\frac{1}{2}}(\lambda)\exp[-\bm{\kappa}(\lambda)] \\
    \bm{\mathcal{S}} =& \mathbf{C}^{\dagger}(0)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(0)
\end{align}
We need to consider the fact that the canonical AO basis is no longer normalised upon external perturbation. The $\bm{\mathcal{S}}^{-\frac{1}{2}}$ part takes care of the normalisation, and
the exponential part ensures the MO rotation is unitary (i.e. preserves orthonormality).

In this way:
\begin{align}
     \mathbf{S}(\lambda) =& \mathbf{C}^{\dagger}(\lambda)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(\lambda) \nonumber \\
    =& \mathbf{U}^{\dagger}(\lambda)\mathbf{C}^{\dagger}(0)\mathbf{S}^{\text{AO}}(\lambda)\mathbf{C}(0)\mathbf{U}(\lambda) \nonumber \\
    =& \mathbf{U}^{\dagger}(\lambda)\bm{\mathcal{S}}(\lambda)\mathbf{U}(\lambda) \nonumber \\
    =& \exp[-\bm{\kappa}(\lambda)]^{\dagger}\bm{\mathcal{S}}^{-\frac{1}{2} \dagger}(\lambda)\bm{\mathcal{S}}(\lambda)\bm{\mathcal{S}}^{-\frac{1}{2}}(\lambda)\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \exp[\bm{\kappa}(\lambda)]\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \mathbf{I}
\end{align}
the orthonormality is ensured (\textcolor{red}{only when $\bm{\mathcal{S}}^{-\frac{1}{2}\dagger}\bm{\mathcal{S}}\bm{\mathcal{S}}^{-\frac{1}{2}} = \mathbf{I}$} holds), and the perturbed orthonormality condition is trivial:
\begin{equation}
    \mathbf{S}^{\lambda} = \pdv{\mathbf{S}(\lambda)}{\lambda}\Big|_{{\lambda = 0}} = \mathbf{0}
\end{equation}
The derivative of $\mathbf{U}(\lambda)$ is no longer needed here but if required, the derivative of $\bm{\mathcal{S}}^{-\frac{1}{2}}(\lambda)$ could be solved by taking derivative on this equation \textcolor{red}{(How to demonstrate this?)}:
\begin{equation}
    \bm{\mathcal{S}}^{-\frac{1}{2}\dagger}\bm{\mathcal{S}}\bm{\mathcal{S}}^{-\frac{1}{2}} = \mathbf{I}
\end{equation}
\textcolor{red}{Does this come naturally? Or do we need to enforce it as the orthonormality condition?}
\textcolor{blue}{require the AO overlap matrix to be Hermitian}
\begin{align}
    \bm{\mathcal{S}}^{-\frac{1}{2}\dagger}\bm{\mathcal{S}}\bm{\mathcal{S}}^{-\frac{1}{2}} = \mathbf{C}^{-\frac{1}{2}\dagger}(0)\mathbf{S}_{\text{AO}}^{-\frac{1}{2}\dagger}\mathbf{C}^{-\frac{1}{2}}(0)\mathbf{C}^{\dagger}(0)\mathbf{S}^{\text{AO}}\mathbf{C}(0)\mathbf{C}^{-\frac{1}{2}\dagger}(0)\mathbf{S}_{\text{AO}}^{-\frac{1}{2}}\mathbf{C}^{-\frac{1}{2}}(0)
\end{align}






Only up to second derivative is needed, hence we can truncate the exponential expansion in $\bm{\kappa}$ to quadratic term:
\begin{equation}
    \exp(-\bm{\kappa}) = \mathbf{I} - \bm{\kappa} + \frac{1}{2}\bm{\kappa}^{2}
\end{equation}
Then the relevant integrals could be expressed as:
\begin{align}
    \mathbf{h} =& \mathbf{C}^{\dagger}(\lambda)\mathbf{h}^{\text{AO}}(\lambda)\mathbf{C}(\lambda) \nonumber \\
    =& \exp[\bm{\kappa}(\lambda)]\bm{\mathcal{S}}^{-\frac{1}{2}\dagger}(\lambda)\mathbf{C}^{\dagger}(0)\mathbf{h}^{\text{AO}}(\lambda)\mathbf{C}(0)\bm{\mathcal{S}}^{-\frac{1}{2}}(\lambda)\exp[-\bm{\kappa}(\lambda)] \nonumber \\
    =& \big(\mathbf{I} + \bm{\kappa} + \frac{1}{2}\bm{\kappa}^{2}\big)\bm{\mathcal{S}}^{-\frac{1}{2}\dagger}(\lambda)\mathbf{C}^{\dagger}(0)\mathbf{h}^{\text{AO}}(\lambda)\mathbf{C}(0)\bm{\mathcal{S}}^{-\frac{1}{2}}(\lambda)\big(\mathbf{I}- \bm{\kappa} +\frac{1}{2}\bm{\kappa}^{2}\big)
\end{align}
\begin{equation}
    \big(\mathbf{I} + \bm{\kappa}+\frac{1}{2}\bm{\kappa}^{2}\big)_{pq} = \delta _{pq} + \kappa _{pq} + \frac{1}{2}\sum_{x}\kappa _{px}\kappa _{xq}
\end{equation}
\begin{align}
    \pdv{\delta _{pq}}{\kappa _{rs}} =& 0 \\
    \pdv{\kappa _{pq}}{\kappa _{rs}} =& \delta _{pr}\delta _{qs}
\end{align}

%This is wrong!:
%\begin{align}
%    h _{pq} =& \sum_{\mu \nu}C _{\mu p}^{*}(\lambda)h ^{\text{AO}}_{\mu \nu}(\lambda)C _{\nu q}(\lambda) \nonumber \\
%    =& \sum_{\mu \nu}\big(\sum_{r}C _{\mu r}^{*}(0)\exp[-\bm{\kappa}(\lambda)]_{rp}^{*}\big)h _{\mu \nu}^{\text{AO}}(\lambda)\big(\sum_{s}C _{\nu s}(0)\exp[-\bm{\kappa}(\lambda)]_{sq}\big) \nonumber \\
%    =& \sum_{\mu \nu rs}\exp[\bm{\kappa}(\lambda)]_{pr}C ^{*}_{\mu r}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\exp[-\bm{\kappa}(\lambda)]_{sq}  \nonumber \\
%    =& \sum_{\mu \nu rs}\Big[\mathbf{I}+ \bm{\kappa}(\lambda)+\frac{1}{2}\bm{\kappa}^{2}(\lambda)\Big]_{pr}C ^{*}_{\mu r}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\Big[\mathbf{I}-\bm{\kappa}(\lambda)+ \frac{1}{2}\bm{\kappa}^{2}(\lambda)\Big]_{sq} \nonumber \\
%    =& \sum_{\mu \nu rs}\Big[\delta _{pr}+ \kappa _{pr} + \frac{1}{2}\sum_{x}\kappa _{px}\kappa _{xr}\Big]C ^{*}_{\mu r}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\Big[\delta _{sq} - \kappa _{sq} + \frac{1}{2}\sum_{y}\kappa _{sy}\kappa _{yq}\Big] \nonumber \\
%\end{align}
%\begin{align}
%    \pdv{h _{pq}}{\kappa _{uw}} =& \sum_{\mu \nu rs}\Big[\pdv{\kappa _{pr}}{\kappa _{uw}}+ \frac{1}{2}\sum_{x}\pdv{\kappa _{px}\kappa _{xr}}{\kappa _{uw}}\Big]C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\Big[-\pdv{\kappa _{sq}}{\kappa _{uw}}+\frac{1}{2}\sum_{y}\pdv{\kappa _{sy}\kappa _{yq}}{\kappa _{uw}}\Big] \nonumber \\
%    =& \sum_{\mu \nu rs}\big[\delta _{pu}\delta _{rw}+\frac{1}{2}\sum_{x}(\delta _{pu}\delta _{xw}\kappa _{xr}+\kappa _{px}\delta _{xu}\delta _{rw})\big]C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0) \big[-\delta _{su}\delta _{qw} \nonumber \\
%    &+\frac{1}{2}\sum_{y}(\delta _{su}\delta _{yw}\kappa _{yq}+ \kappa _{sy}\delta _{yu}\delta _{qw})\big]  \nonumber \\
%    =& -\sum_{\mu \nu rs}\delta _{pu}\delta _{rw}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\delta _{su}\delta _{qw} \nonumber \\
    %&+\frac{1}{2}\sum_{\mu \nu rsy}\delta _{pu}\delta _{rw}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\delta _{su}\delta _{yw}\kappa _{yq} \nonumber \\
    %&+\frac{1}{2}\sum_{\mu \nu rsy}\delta _{pu}\delta _{rw}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\kappa _{sy}\delta _{yu}\delta _{qw} \nonumber \\
    %&-\frac{1}{2}\sum_{\mu \nu rsx}\delta _{pu}\delta _{xw}\kappa _{xr}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\delta _{su}\delta _{qw} \nonumber \\
    %&+\frac{1}{4}\sum_{\mu \nu rsxy}\delta _{pu}\delta _{xw}\kappa _{xr}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\delta _{su}\delta _{yw}\kappa _{yq} \nonumber \\
    %&+ \frac{1}{4}\sum_{\mu \nu rsxy}\delta _{pu}\delta _{xw}\kappa _{xr}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\kappa _{sy}\delta _{yu}\delta _{qw} \nonumber \\
    %&-\frac{1}{2}\sum_{\mu \nu rsx}\kappa _{px}\delta _{xu}\delta _{rw}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\delta _{su}\delta _{qw} \nonumber \\
    %&+\frac{1}{4}\sum_{\mu \nu rsxy}\kappa _{px}\delta _{xu}\delta _{rw}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\delta _{su}\delta _{yw}\kappa _{yq} \nonumber \\
    %&+\frac{1}{4}\sum_{\mu \nu rsxy}\kappa _{px}\delta _{xu}\delta _{rw}C _{\mu r}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu s}(0)\kappa _{sy}\delta _{yu}\delta _{qw} \nonumber \\
    %=& -\sum_{\mu \nu}\delta _{pu}C _{\mu w}^{*}(0)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu u}(0)\delta _{qw}
%\end{align}

\begin{align}
    h _{pq} =& \sum_{\mu \nu}C _{\mu p}^{*}(\lambda)h _{\mu \nu}^{\text{AO}}(\lambda)C _{\nu q}(\lambda) \nonumber \\
    =& \sum_{\mu \nu rs}C _{\mu r}^{*}(0)U _{rp}^{*}(\lambda)h _{\mu \nu}^{\text{AO}}(\lambda)C _{vs}(0)U _{sq}(\lambda) \nonumber \\
    =& \sum_{\mu \nu rstu}C _{\mu r}^{*}\mathcal{S}_{rt}^{-\frac{1}{2}*}\exp[-\bm{\kappa}]_{tp}^{*}h _{\mu \nu}^{\text{AO}}C _{\nu s}\mathcal{S} _{su}^{-\frac{1}{2}}\exp[-\bm{\kappa}]_{uq} \\ \nonumber
    =& \sum_{\mu \nu rstu}C _{\mu r}^{*}\mathcal{S}_{rt}^{-\frac{1}{2}*}\exp[\bm{\kappa}]_{pt}h _{\mu \nu}^{\text{AO}}C _{\nu s}\mathcal{S} _{su}^{-\frac{1}{2}}\exp[-\bm{\kappa}]_{uq} \\ \nonumber
    =& \sum_{\mu \nu rstu}C _{\mu r}^{*}\mathcal{S}_{rt}^{-\frac{1}{2}*}\left[\delta _{pt}+\kappa _{pt}+\dots\right]h _{\mu \nu}^{\text{AO}}C _{\nu s}\mathcal{S} _{su}^{-\frac{1}{2}}\left[\delta _{uq}-\kappa _{uq}+\dots\right] \nonumber \\
    =& \sum_{\mu \nu rstu}C _{\mu r}^{*}\mathcal{S}_{rt}^{-\frac{1}{2}*}h _{\mu \nu}^{\text{AO}}C _{\nu s}\mathcal{S} _{su}^{-\frac{1}{2}}\left[\delta _{pt}\delta _{uq}-\delta _{pt}\kappa _{uq}+\delta _{uq}\kappa _{pt}-\kappa _{pt}\kappa _{uq}\right]
\end{align}
By $\bm{\kappa}(\lambda=0)=\mathbf{0}$, we only need to expand the exponential to first order when taking derivative w.r.t. $\bm{\kappa}$:
\begin{align}
    \pdv{h _{pq}}{\kappa _{vw}}\Big|_{{\lambda =0}} =& \sum_{\mu \nu rstu}C _{\mu r}^{*}\mathcal{S}_{rt}^{-\frac{1}{2}*}h _{\mu \nu}^{\text{AO}}C _{\nu s}\mathcal{S} _{su}^{-\frac{1}{2}}\left(0-\delta _{pt}\pdv{\kappa _{uq}}{\kappa _{vw}}\Big|_{{\lambda =0}}+\delta _{uq}\pdv{\kappa _{pt}}{\kappa _{vw}}\Big|_{{\lambda=0}}\right) \nonumber \\
    =&\sum_{\mu \nu rstu}C _{\mu r}^{*}\mathcal{S} _{rt}^{-\frac{1}{2}*}h _{\mu \nu}^{\text{AO}}C _{\nu s}\mathcal{S} _{su}^{-\frac{1}{2}}\left(-\delta _{pt}\delta _{uv}\delta _{qw} + \delta _{uq}\delta _{pv}\delta _{tw}\right)
\end{align} 
Note that $\bm{\mathcal{S}}(\lambda=0)=\mathbf{U}(\lambda=0)=\mathbf{I}$, then:
\begin{align}
    \pdv{h _{pq}}{\kappa _{vw}}\Big|_{{\lambda=0}} =& \sum_{\mu \nu rstu}C _{\mu r}^{*}\delta _{rt}h _{\mu \nu}^{\text{AO}}C _{vs}\delta _{su}\delta _{uq}\delta _{pv}\delta _{tw} - \sum_{\mu \nu rstu}C _{\mu r}^{*}\delta _{rt}h _{\mu \nu}^{\text{AO}}C _{\nu s}\delta _{su}\delta _{pt}\delta _{uv}\delta _{qw} \nonumber \\
    =& \sum_{\mu \nu}C _{\mu w}^{*}h _{\mu \nu}^{\text{AO}}C _{\nu q}\delta _{pv} - \sum_{\mu \nu}C _{\mu p}^{*}h _{\mu \nu}^{\text{AO}}C _{\nu v}\delta _{qw} \nonumber \\
    =& h _{wq}\delta _{pv}-h _{pv}\delta _{qw}
\end{align} 
Change the indices for convenience (and using the fact that the Hamiltonian is Hermitian):
\begin{equation}
    \pdv{h _{pq}}{\kappa _{rs}}\Big|_{{\lambda=0}} = h _{qs}\delta _{pr} - h _{pr}\delta _{qs}
\end{equation}
hence:
\begin{align}
    \sum_{pq}\pdv{h _{pq}}{\kappa _{rs}}\Big|_{{\lambda=0}}=&\sum_{pq} h _{qs}\delta _{pr}-h _{pr}\delta _{qs}
\end{align}

Now the two-electron integral:
\begin{align}
    \langle pq||rs\rangle =& \sum_{\mu \nu \sigma \tau} C _{\mu p}^{*}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}C _{\tau s} \nonumber \\
    =& \sum_{\mu \nu \sigma \tau}\sum_{tuvw} C _{\mu t}^{*}U _{tp}^{*}C _{\nu u}^{*}U ^{*}_{u q}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}U _{vr} C  _{\tau w}U _{ws} \nonumber \\
    =& \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn} C _{\mu t}^{*}\mathcal{S} ^{-\frac{1}{2}*}_{tg}\exp[-\bm{\kappa}]^{*}_{gp}C _{\nu u}^{*}\mathcal{S} ^{-\frac{1}{2}*}_{uh}\exp[-\bm{\kappa}]_{hq}^{*} \nonumber \\ 
    &\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}\mathcal{S} ^{-\frac{1}{2}}_{v m}\exp[-\bm{\kappa}]_{mr}C _{\tau w}\mathcal{S} ^{-\frac{1}{2}}_{wn}\exp[-\bm{\kappa}]_{ns} \nonumber \\
    =& \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn} C ^{*}_{\mu t}\mathcal{S} _{tg}^{-\frac{1}{2}*}\left(\delta _{pg}+\kappa _{pg}\right)C _{\nu u}^{*}\mathcal{S} ^{-\frac{1}{2}*}_{uh}\left(\delta _{qh}+ \kappa _{qh}\right) \nonumber \\
    & \langle \mu \nu ||\sigma \tau\rangle C _{\sigma v}\mathcal{S} ^{-\frac{1}{2}}_{vm}\left(\delta _{mr}-\kappa _{mr}\right)C _{\tau w}\mathcal{S}^{-\frac{1}{2}}_{wn}\left(\delta _{ns}-\kappa _{ns}\right) \nonumber \\
    =& \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn} C _{\mu t}^{*}\mathcal{S} _{tg}^{-\frac{1}{2}*}C _{\nu u}^{*}\mathcal{S} _{uh}^{-\frac{1}{2}*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}\mathcal{S} _{vm}^{-\frac{1}{2}}C _{\tau w}\mathcal{S} _{wn}^{-\frac{1}{2}}(\kappa _{pg}\delta _{qh}\delta _{mr}\delta _{ns} \nonumber \\
    &+\kappa _{qh}\delta _{pg}\delta _{mr}\delta _{ns}-\kappa _{mr}\delta _{pg}\delta _{qh}\delta _{ns}-\kappa _{ns}\delta _{pg}\delta _{qh}\delta _{mr} + \dots)
\end{align} 
now take derivative w.r.t. $\bm{\kappa}$, noting that $\mathbf{U}(\lambda=0) = \bm{\mathcal{S}}(\lambda=0)=\mathbf{I}$:
\begin{align}
    \pdv{\langle pq||rs\rangle}{\kappa _{xy}}\Big|_{{\lambda=0}} =& \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn} C _{\mu t}^{*}C _{\nu u}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}C _{\tau w}\delta _{tg}\delta _{uh}\delta _{vm}\delta _{wn}\Big(\pdv{\kappa _{pg}}{\kappa _{xy}}\Big|_{{\lambda=0}}\delta _{qh}\delta _{mr}\delta _{ns} \nonumber \\
    &+ \pdv{\kappa _{qh}}{\kappa _{xy}}\Big|_{{\lambda=0}}\delta _{pg}\delta _{mr}\delta _{ns} - \pdv{\kappa _{mr}}{\kappa _{xy}}\Big|_{{\lambda =0}}\delta _{pg}\delta _{qh}\delta _{ns} - \pdv{\kappa _{ns}}{\kappa _{xy}}\delta _{pg}\delta _{qh}\delta _{mr}\Big) \nonumber \\
    =& \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn} C _{\mu t}^{*}C _{\nu u}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}C _{\tau w}\delta _{tg}\delta _{uh}\delta _{vm}\delta _{wn}\delta _{px}\delta _{gy}\delta _{qh}\delta _{mr}\delta _{ns} \nonumber \\
    &+ \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn}C _{\mu t}^{*}C _{\nu u}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}C _{\tau w}\delta _{tg}\delta _{uh}\delta _{vm}\delta _{wn}\delta _{qx}\delta _{hy}\delta _{pg}\delta _{mr}\delta _{ns} \nonumber \\
    &- \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn}C _{\mu t}^{*}C _{\nu u}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}C _{\tau w}\delta _{tg}\delta _{uh}\delta _{vm}\delta _{wn}\delta _{mx}\delta _{ry}\delta _{pg}\delta _{qh}\delta _{ns} \nonumber \\
    &- \sum_{\mu \nu \sigma \tau}\sum_{tuvw}\sum_{ghmn}C _{\mu t}^{*}C _{\nu u}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma v}C _{\tau w}\delta _{tg}\delta _{uh}\delta _{vm}\delta _{wn}\delta _{nx}\delta _{sy}\delta _{pg}\delta _{qh}\delta _{mr} \nonumber \\
    =& \sum_{\mu \nu \sigma \tau}C _{\mu y}^{*}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}C _{\tau s}\delta _{px} + \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu y}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}C _{\tau s}\delta _{qx} \nonumber \\
    &- \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma x}C _{\tau s}\delta _{ry} - \sum_{\mu \nu \sigma \tau}C _{\mu p}^{*}C _{\nu q}^{*}\langle \mu \nu||\sigma \tau\rangle C _{\sigma r}C _{\tau x}\delta _{sy} \nonumber \\
    =& \langle yq||rs\rangle \delta _{px} + \langle py||rs\rangle \delta _{qx} - \langle pq||xs\rangle \delta _{ry} - \langle pq||rx\rangle \delta _{sy}
\end{align}





Therefore, the orbital response for fock matrix is:
\begin{align}
    \pdv{f _{ai}}{\kappa _{pq}}\Big|_{{\lambda=0}} =& \pdv{h _{ai}}{\kappa _{pq}}\Big|_{{\lambda=0}} + \sum_{k}\pdv{\langle ak||ik\rangle}{\kappa _{pq}}\Big|_{{\lambda=0}} \nonumber \\
    =& h _{iq}\delta _{ap} - h _{ap}\delta _{iq} + \sum_{k}\langle qk||ik\rangle \delta _{ap} + \sum_{k}\langle aq||ik\rangle \delta _{pk} \nonumber \\
    &-\sum_{k}\langle ak||pk\rangle \delta _{iq} - \sum_{k}\langle ak||ip\rangle \delta _{kq} \nonumber \\
    =& \delta _{ap}\Big(h _{iq}+\sum_{k}\langle qk||ik\rangle\Big) - \delta _{iq}\Big(h _{ap}+\sum_{k}\langle ak||pk\rangle\Big) \nonumber \\
    & + \sum_{k}\langle aq||ik\rangle \delta _{pk} - \sum_{k}\langle ak||ip\rangle \delta _{qk} \nonumber \\
    =& \delta _{ap}f _{iq} - \delta _{iq}f _{ap} + \langle aq||ip\rangle - \langle aq||ip\rangle \nonumber \\
    =& \delta _{ap}\delta _{iq}\varepsilon _{i} - \delta _{iq}\delta _{ap}\varepsilon _{a} \nonumber \\
    =& (\varepsilon _{i}-\varepsilon _{a})\delta _{ap}\delta _{iq}
\end{align}
thus the only non-redundant orbital response is:
\begin{equation}
    \pdv{f _{ai}}{\kappa _{bj}}\Big|_{{\lambda=0}} = (\varepsilon _{i}-\varepsilon _{a})\delta _{ab}\delta _{ij}
\end{equation}

Then, the orbital response for the Hylleraas functional:
\begin{equation}
    E _{\text{H}} = \sum_{ij}h _{ij}\gamma _{ij} + \sum_{ab}h _{ab}\gamma _{ab} + \sum_{ijab}\langle ab||ij\rangle \Gamma _{ij}^{ab}+\sum_{ijkl}\langle ij||kl\rangle \Gamma _{kl}^{ij} + \sum_{ijab}\langle ai||bj\rangle \Gamma _{bj}^{ai}
\end{equation}
\begin{align}
    \pdv{h _{ij}}{\kappa _{pq}}\Big|_{{\lambda=0}} =& h _{jq}\delta _{ip}- h _{ip}\delta _{jq} \\
    \pdv{h _{ab}}{\kappa _{pq}}\Big|_{{\lambda=0}} =& h _{bq}\delta _{ap}- h _{ap}\delta _{bq}
\end{align}
\begin{align}
    \pdv{\langle ab||ij\rangle}{\kappa _{pq}}\Big|_{{\lambda=0}} =& \langle qb||ij\rangle \delta _{ap} + \langle aq||ij\rangle \delta _{bp} - \langle ab||pj\rangle \delta _{iq} - \langle ab||ip\rangle \delta _{jq} \\
    \pdv{\langle ij||kl\rangle}{\kappa _{pq}}\Big|_{{\lambda=0}} =& \langle qj||kl\rangle \delta _{ip} + \langle iq||kl\rangle \delta _{jp} - \langle ij||pl\rangle \delta _{kq} - \langle ij||kp\rangle \delta _{lq} \\
    \pdv{\langle ai||bj\rangle}{\kappa _{pq}}\Big|_{{\lambda=0}} =& \langle qi||bj\rangle \delta _{ap} + \langle aq||bj\rangle \delta _{ip} - \langle ai||pj\rangle \delta _{bq} - \langle ai||bp\rangle \delta _{jq}
\end{align}












































\end{document}